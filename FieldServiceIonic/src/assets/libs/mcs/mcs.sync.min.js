/**
* Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
 * Oracle Mobile Cloud Service Sync JavaScript SDK, Release: 18.1.3.0, E93562-01
*/


!function(a){function b(a){for(var c=b.options,d=c.parser[c.strictMode?"strict":"loose"].exec(a),e={},f=14;f--;)e[c.key[f]]=d[f]||"";return e[c.q.name]={},e[c.key[12]].replace(c.q.parser,function(a,b,d){b&&(e[c.q.name][b]=d)}),e}function c(a){for(var b,c=[],d=0,f=0,g="";null!=(b=G.exec(a));){var h=b[0],i=b[1],j=b.index;if(g+=a.slice(f,j),f=j+h.length,i)g+=i[1];else{var k=a[f],l=b[2],m=b[3],n=b[4],o=b[5],p=b[6],q=b[7];g&&(c.push(g),g="");var r=null!=l&&null!=k&&k!==l,s="+"===p||"*"===p,t="?"===p||"*"===p,u=b[2]||"/",v=n||o||(q?".*":"[^"+u+"]+?");c.push({name:m||d++,prefix:l||"",delimiter:u,optional:t,repeat:s,partial:r,asterisk:!!q,pattern:e(v)})}}return f<a.length&&(g+=a.substr(f)),g&&c.push(g),c}function d(a){return a.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function e(a){return a.replace(/([=!:$\/()])/g,"\\$1")}function f(a,b){return a.keys=b,a}function g(a){return a.sensitive?"":"i"}function h(a,b){var c=a.source.match(/\((?!\?)/g);if(c)for(var d=0;d<c.length;d++)b.push({name:d,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return f(a,b)}function i(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(l(a[e],b,c).source);return f(new RegExp("(?:"+d.join("|")+")",g(c)),b)}function j(a,b,d){for(var e=c(a),g=k(e,d),h=0;h<e.length;h++)"string"!=typeof e[h]&&b.push(e[h]);return f(g,b)}function k(a,b){b=b||{};for(var c=b.strict,e=!1!==b.end,f="",h=a[a.length-1],i="string"==typeof h&&/\/$/.test(h),j=0;j<a.length;j++){var k=a[j];if("string"==typeof k)f+=d(k);else{var l=d(k.prefix),m="(?:"+k.pattern+")";k.repeat&&(m+="(?:"+l+m+")*"),m=k.optional?k.partial?l+"("+m+")?":"(?:"+l+"("+m+"))?":l+"("+m+")",f+=m}}return c||(f=(i?f.slice(0,-2):f)+"(?:\\/(?=$))?"),f+=e?"$":c&&i?"":"(?=\\/|$)",new RegExp("^"+f,g(b))}function l(a,b,c){return b=b||[],F(b)?c||(c={}):(c=b,b=[]),a instanceof RegExp?h(a,b):F(a)?i(a,b,c):j(a,b,c)}function m(){"use strict";function a(a){return Object.prototype.toString.call(a).replace(/^\[object (.+)\]$/,"$1").toLowerCase()}function b(b,c){return"string"===a(b)&&b.slice(0,c.length)==c}function c(b,c){return"string"===a(b)&&(""==c||b.slice(-c.length)==c)}function d(a){return a=a||{},JSON.parse(JSON.stringify(a))}function e(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=f(a[c]);b.push(d)}return b}function f(a){var b=d(a);return delete b.$loki,delete b.meta,b}function g(){return Math.floor(4294967296*Math.random())}function h(a,b){return B.call(b)==="[object "+a+"]"}function i(a){return h("Date",a)}function j(a){return h("String",a)}function k(a){return void 0===a}function l(a,b){return null!=a&&C.call(a,b)}function m(a){return m(a)&&!n(parseFloat(a))}function n(a){return v(a)&&a!==+a}function o(a){return!0===a||!1===a||"[object Boolean]"===B.call(a)}function p(a){if(null===a)return!0;if(q(a)&&(r(a)||"string"==typeof a||s(a.splice)||s(a.callee)))return!a.length;if(a&&"object"==typeof a){var b=a.toString();if("[object Map]"==b||"[object Set]"==b)return!a.size}for(var c in a)if(a.hasOwnProperty(c))return!1;return!a||!v(a)}function q(a){return a&&"object"==typeof a&&"number"==typeof a.length&&a.length>=0&&a.length%1==0}function r(a){return Array.isArray(a)}function s(a){return"function"==typeof a||!1}function t(a){var b=typeof a;return"function"===b||"object"===b&&!!a}function u(a){return null===a}function v(a){return"number"==typeof a||"[object Number]"==a.toString()}function w(a){return function(b){var c=arguments.length;if(null==b||c<2)return b;for(var d=1;d<c;d++){var e=arguments[d];if(e&&t(e))for(var f in e)(a||e.hasOwnProperty(f))&&(b[f]=e[f])}return b}}function x(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1,k=Object.prototype.toString,l=Object.prototype.hasOwnProperty,o=(Array.prototype.push,Array.prototype.slice,String.prototype.trim,Array.prototype.indexOf,{"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"}),p={isFunction:function(a){return"function"===p.type(a)},isArray:Array.isArray||function(a){return"array"===p.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){return!n(parseFloat(a))&&m(a)},type:function(a){return null==a?String(a):o[k.call(a)]||"object"},isPlainObject:function(a){if(!a||"object"!==p.type(a)||a.nodeType)return!1;try{if(a.constructor&&!l.call(a,"constructor")&&!l.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var b;for(b in a);return void 0===b||l.call(a,b)}};for("boolean"==typeof g&&(j=g,g=arguments[1]||{},h=2),"object"==typeof g||p.isFunction(g)||(g={}),i===h&&(g=this,--h),h;h<i;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(p.isPlainObject(d)||(e=p.isArray(d)))?(e?(e=!1,f=c&&p.isArray(c)?c:[]):f=c&&p.isPlainObject(c)?c:{},g[b]=x(j,f,d)):void 0!==d&&(g[b]=d));return g}var y=Array.prototype,z=Object.prototype,A=Function.prototype,B=(y.push,y.slice,z.toString),C=z.hasOwnProperty;Array.isArray,Object.keys,A.bind,Object.create;return{isEmpty:p,isArray:r,isFunction:s,isObject:t,isNull:u,isNumber:v,isDate:i,isString:j,isUndefined:k,has:l,isFinite:m,isNaN:n,isBoolean:o,deepExtend:x,extendOwn:w(!1),extend:w(!0),getUID:g,clone:d,stringStartsWith:b,stringEndsWith:c,type:a,cleanObjects:e,cleanObject:f}}function n(a,b){"use strict";function c(a){try{return decodeURIComponent(a)}catch(b){throw Error('failed to decode param "'+a+'"')}}function d(a){return a.indexOf("d")>=0}function e(a){return a||a.value?a.isInteger?parseInt(a.value):a.value:""}function f(a){if(a.match[0]in x)return x[a.match[0]];for(var b={root:a.uri.tokens[0],attr:[]},c=a.uri.tokens,e=1,f=1;f<c.length;f++)if(t.isObject(a.uri.tokens[f])){var g=e++,h=a.uri.tokens[f];a.match[g]&&b.attr.push({name:t.stringStartsWith(h.name,"/")||t.stringStartsWith(h.name,"_")?h.name.substring(1):h.name,value:a.match[g],pattern:h.pattern,is:!(!t.stringStartsWith(h.name,"/")&&!t.stringStartsWith(h.name,"_")),isInteger:d(h.pattern)})}else{var h=a.uri.tokens[f];h&&b.attr.push({name:h,value:t.stringStartsWith(h,"/")||t.stringStartsWith(h,"_")?h.substring(1):h,is:!1,isInteger:d(h)})}return x[a.match[0]]=b}function g(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}function h(a,b,c,d){return a&&"object"==typeof a?!t.isArray(b)||!b.length>0?a:b.reduce(function(a,f,g){if(f.isProperty&&(a[f.name]=a[f.name]||[]),b.length==g+1){if(f.isProperty){if(Array.isArray(c))return a[f.name]=c,c;if(d){var h=a[f.name];for(var g in h)if(h.hasOwnProperty(g)&&h[g][d.key.name]===d.value){t.deepExtend(h[g],c);break}}else a[f.name].push(c);return c}if(Array.isArray(a)){var i=a.findIndex(function(a){return a[f.name]==e(f)});return i>-1?t.deepExtend(a[i],c):(c[f.name]=e(f),a.push(c)),c}return a[f.name]==e(f)?(t.deepExtend(a,c),c):(a[f.name]=e(f),t.deepExtend(a,c),c)}if(f.isProperty)return a[f.name];if(Array.isArray(a)){var i=a.findIndex(function(a){a[f.name]=e(f)});return i>-1?a[i]:{}}return a[f.name]==e(f)?a:a[f.name]=e(f)},a):a}function i(a,b){return a&&"object"==typeof a?!t.isArray(b)||!b.length>0?a:b.reduce(function(a,b){if(b.isProperty)return a&&a[b.name];var c={name:b.name,value:e(b)};if(Array.isArray(a)&&!b.isProperty){var d=a.findIndex(function(a){return a[c.name]==c.value});return d>-1?a[d]:a[c.name]&&a}return b.isProperty?a&&a[c.name]:a[c.name]==c.value?a:a[c.name]&&a},a):a}function j(a){var b={};if(!a)return b;for(var c=a.split("\r\n"),d=0,e=c.length;d<e;d++){var f=c[d],g=f.indexOf(": ");g>0&&(b[f.substring(0,g).toLowerCase()]=f.substring(g+2))}return b}function k(a){var c=b.parseURL(a);return w(c.path)}function m(a,b){var c=k(a);if(t.isEmpty(c)||!1===c)throw new Error("give url was configured for persistence:"+a);return b?c:f(c)}function n(a,b){var c=b?JSON.parse(JSON.stringify(a)):a;return c.hasOwnProperty("$loki")&&"number"==typeof c.$loki&&!isNaN(c.$loki)&&delete c.$loki,c.hasOwnProperty("meta")&&delete c.meta,c}function o(){return!!(window.cordova||window.PhoneGap||window.phonegap||window.forge)}function p(a){return!0}function q(a,b){return!!a.hasOwnProperty(r(b))}function r(a){var b=a.toLowerCase();return z.indexOf(b)>-1?b:a}function s(a){return"$loki"in a&&"number"==typeof a.$loki&&!isNaN(a.$loki)}var t=a,u=function(a){return a=a||{},function(b){var d=[],e=l(b,d,a);return function(a,b){var f=e.exec(a);if(!f)return!1;b=b||[];for(var g,h,i={},j=0;j<d.length;j++)g=d[j],(h=f[j+1])&&(i={name:g.name,value:c(h)},b.push(i),g.repeat&&(b[b.length-1].name=b[b.length-1].name.split(g.delimiter)));return b}}},v={},w=function(a){if(null==a||"string"!=typeof a)return console.warn("isPersistentUrl -> path can be only string"),!1;if(a in v)return v[a];for(var c=b.persistUris.length,d=0;d<c;d++){var e=b.persistUris[d].reg.exec(a);if(e)return v[a]={uri:b.persistUris[d],match:e}}return v[a]=!1},x={},y=function(a,b,c){c||(c={});var d=a.split(/\./);d.length<2?c[d[0]]=b:(c[d[0]]||(c[d[0]]={}),c=c[d.shift()],y(d.join("."),b,c))},z=["delete","get","head","options","post","put","patch"];return{isPersistUrl:w,isPersistentURL:k,extractKeyValuesFromUrl2:f,param:g,setData:y,parseResponseHeaders:j,cleanSyncLogObjectFromDBSpecificProperties:n,isWebView:o,isURLConfiguredForPersistence:m,pathToMatch:u,isMcsSyncResourceType:p,isSupportedHTTPMethod:q,normalizeMethod:r,isLokiDbObj:s,isUrlRegexInteger:d,setNestedProperty2:h,getNestedProperty:i}}function o(a){"use strict";function d(a){try{return decodeURIComponent(a)}catch(b){throw Error('failed to decode param "'+a+'"')}}function e(a){return j?document.addEventListener("deviceready",function(){a(!0)},!1):a(!1),e}function f(a){if("string"!=typeof a)return console.warn("isPersistentUrl -> path can be only string"),!1;if((a=this.parseURL(a).path)in p)return p[a];for(var b=o.length,c=0;c<b;c++)try{var d=o[c].matchURI(a);if(!1===d)continue;return p[a]={params:d,root:o[c].tokens[0],path:a,tokens:o[c].tokens.slice(1),policies:o[c].policies,isPolicy:function(a,b){if("string"==typeof a)return!(!this.policies||!this.policies.hasOwnProperty(a))&&(void 0===b||this.policies[a]===b)}}}catch(e){return console.error(e),p[a]=!1}return p[a]=!1}var g=a,h=null,i=!0,j=void 0!==window.cordova,k=3e4,m=3e4,n={},o=[],p={},q={},r=null,s=!1,t=!0,u=!1,v=!1,w=0,x=!1,y=!1,z="offline",A="synclog",B="persist",C=function(a,b){return console.log(" changed from "+a+" to "+b),b},D=!1,E=null,F={PERIODIC_REFRESH_POLICY_REFRESH_NONE:"PERIODIC_REFRESH_POLICY_REFRESH_NONE",PERIODIC_REFRESH_POLICY_REFRESH_EXPIRED_ITEM_ON_STARTUP:"PERIODIC_REFRESH_POLICY_REFRESH_EXPIRED_ITEM_ON_STARTUP",PERIODIC_REFRESH_POLICY_PERIODICALLY_REFRESH_EXPIRED_ITEMS:"PERIODIC_REFRESH_POLICY_PERIODICALLY_REFRESH_EXPIRED_ITEMS"},G={FETCH_FROM_CACHE:"FETCH_FROM_CACHE",FETCH_FROM_SERVICE:"FETCH_FROM_SERVICE",FETCH_FROM_SERVICE_IF_ONLINE:"FETCH_FROM_SERVICE_IF_ONLINE",FETCH_FROM_SERVICE_ON_CACHE_MISS:"FETCH_FROM_SERVICE_ON_CACHE_MISS",FETCH_FROM_SERVICE_ON_CACHE_MISS_OR_EXPIRY:"FETCH_FROM_SERVICE_ON_CACHE_MISS_OR_EXPIRY",FETCH_FROM_CACHE_SCHEDULE_REFRESH:"FETCH_FROM_CACHE_SCHEDULE_REFRESH",FETCH_WITH_REFRESH:"FETCH_WITH_REFRESH"},H={EXPIRE_ON_RESTART:"EXPIRE_ON_RESTART",EXPIRE_AFTER:"EXPIRE_AFTER",NEVER_EXPIRE:"NEVER_EXPIRE"},I={EVICT_ON_EXPIRY_AT_STARTUP:"EVICT_ON_EXPIRY_AT_STARTUP",MANUAL_EVICTION:"MANUAL_EVICTION"},J={UPDATE_IF_ONLINE:"UPDATE_IF_ONLINE",QUEUE_IF_OFFLINE:"QUEUE_IF_OFFLINE"},K={CLIENT_WINS:"CLIENT_WINS",PRESERVE_CONFLICT:"PRESERVE_CONFLICT",SERVER_WINS:"SERVER_WINS"},L={periodicRefreshPolicy:F.PERIODIC_REFRESH_POLICY_REFRESH_NONE,periodicRefreshInterval:120},M={conflictResolutionPolicy:K.PRESERVE_CONFLICT,evictionPolicy:I.MANUAL_EVICTION,expirationPolicy:H.EXPIRE_ON_RESTART,expireAfter:Number.MAX_VALUE,fetchPolicy:G.FETCH_FROM_SERVICE_IF_ONLINE,noCache:!1,updatePolicy:J.UPDATE_IF_ONLINE};L.default=M;var N=function(a){if(!a)throw console.error("config cannot be empty object"),new Error("config cannot be empty object");if(!g.isObject(a))throw console.error("policy is not object"),new Error("policy is not object");var b,c=!1;for(b in a)if(a.hasOwnProperty(b)){c=!0;break}if(!c)throw console.error("policy object does not contain any properties!"),new Error("policy object does not contain any properties!");O(a),P(a)},O=function(a){a.hasOwnProperty("default")&&(console.debug("apply new default policies"),a.default.conflictResolutionPolicy in K&&(M.conflictResolutionPolicy=a.default.conflictResolutionPolicy||K.PRESERVE_CONFLICT),a.default.evictionPolicy in I&&(M.evictionPolicy=a.default.evictionPolicy||I.MANUAL_EVICTION),a.default.expirationPolicy in H&&(M.expirationPolicy=a.default.expirationPolicy||H.EXPIRE_ON_RESTART),"number"==typeof a.default.expireAfter&&(M.expireAfter=a.default.expireAfter||Number.MAX_VALUE),a.default.fetchPolicy in G&&(M.fetchPolicy=a.default.fetchPolicy||G.FETCH_FROM_SERVICE_IF_ONLINE),"boolean"==typeof a.default.noCache&&(M.noCache=a.default.noCache||!1),a.default.updatePolicy in J&&(M.updatePolicy=a.default.updatePolicy||J.UPDATE_IF_ONLINE))},P=function(a){if(a.hasOwnProperty("periodicRefreshPolicy")&&F.hasOwnProperty(a.periodicRefreshPolicy)&&(L.periodicRefreshPolicy=a.periodicRefreshPolicy||F.PERIODIC_REFRESH_POLICY_REFRESH_NONE),a.hasOwnProperty("periodicRefreshInterval")&&"number"==typeof a.periodicRefreshInterval&&(L.periodicRefreshInterval=a.periodicRefreshInterval||12e4),!a.hasOwnProperty("policies"))throw console.error("synchronisation configuration requires path policies"),new Error("synchronisation configuration requires path policies");R(a.policies)},Q=function(a){var b=JSON.parse(JSON.stringify(M));return"conflictResolutionPolicy"in a&&a.conflictResolutionPolicy in K&&(b.conflictResolutionPolicy=a.conflictResolutionPolicy||K.PRESERVE_CONFLICT),"evictionPolicy"in a&&a.evictionPolicy in I&&(b.evictionPolicy=a.evictionPolicy||I.MANUAL_EVICTION),"expirationPolicy"in a&&a.expirationPolicy in H&&(b.expirationPolicy=a.expirationPolicy||H.EXPIRE_ON_RESTART),"expireAfter"in a&&"number"==typeof a.expireAfter&&(b.expireAfter=a.expireAfter||Number.MAX_VALUE),"fetchPolicy"in a&&a.fetchPolicy in G&&(b.fetchPolicy=a.fetchPolicy||G.FETCH_FROM_SERVICE_IF_ONLINE),"noCache"in a&&"boolean"==typeof a.noCache&&(b.noCache=a.noCache||!1),"updatePolicy"in a&&a.updatePolicy in J&&(b.updatePolicy=a.updatePolicy||J.UPDATE_IF_ONLINE),b},R=function(a){if(!Array.isArray(a))throw console.error("Persistence.Options.persistUris","param should be array!"),new Error("Persistence.Options.persistUris","param should be array!");var b=S({sensitive:!0,strict:!1,end:!0}),d=[];if(L.policies=a,null!=a&&Array.isArray(a)){for(var e=a.length,f=0;f<e;f++){var g={};a[f].hasOwnProperty("path")&&(g.uri=a[f].path,g.reg=l(g.uri,[],{sensitive:!0}),g.tokens=c(g.uri),g.matchURI=b(g.uri),g.policies=Q(a[f]),L.policies[f]=g.policies,L.policies[f].path=g.uri,o.push(g),d.push(g.uri))}n=l(d,[],{sensitive:!0})}},S=function(a){return a=a||{},function(b){var c=[],e=l(b,c,a);return function(a,b){var f=e.exec(a);if(!f)return!1;b=b||[];for(var g,h,i={},j=0;j<c.length;j++)g=c[j],(h=f[j+1])&&(i={name:g.name,value:d(h)},b.push(i),g.repeat&&(b[b.length-1].name=b[b.length-1].name.split(g.delimiter)));return b}}},T=function(a){"loading"!==document.readyState?a():document.addEventListener?document.addEventListener("DOMContentLoaded",a):document.attachEvent("onreadystatechange",function(){"loading"!==document.readyState&&a()})};e(function(a){if(a){var b=function(){console.log("online callback")},c=function(){console.log("offline callback")},d=function(){console.log("pauseAppCallback")},e=function(){console.log("pauseAppCallback")};document.addEventListener("offline",c,!1),document.addEventListener("online",b,!1),document.addEventListener("resume",e,!1),document.addEventListener("pause",d,!1)}}),T(function(){function a(a){var c=navigator.onLine?"online":"offline";b=c,console.log("before end","Event: "+a.type+"; Status: "+c)}var b=navigator.onLine?"online":"offline";window.addEventListener("online",a),window.addEventListener("offline",a)});var U=function(a){if(g.isObject(a)&&a.hasOwnProperty("url")&&a.hasOwnProperty("mcs")){var b=f(a.url);if(!1===b)throw new Error("Persistence.Options.setUrlCache()-> URI was not configured for persistence:"+a.url);a.url=b.root;var c=h.getCollectionByName("options"),d=c.findOne({url:b.root});return d?(g.extendOwn(d,a),c.update(d)):c.insert(a)}},V=function(a){return{mcs:!0}};return{isPersistentUrl:f,ready:T,set dbFirst(a){"boolean"==typeof a&&(i=a)},get dbFirst(){return i},set timeout(a){"number"==typeof a&&(k=a||k)},get timeout(){return k},set syncTimeOut(a){"number"==typeof a&&(m=a||m)},get syncTimeOut(){return m},parseURL:function(a){if("string"!=typeof a)throw console.error("Persistence.Options.parseURL -> path can be only string"),new Error("Persistence.Options.parseURL -> path can be only string");return a in q?q[a]:q[a]=b(a)},get persistUris(){return o},set persistUris(a){R(a)},set onTimeOut(a){"function"==typeof a&&(this.ontimeout=a)},set onError(a){"function"==typeof a&&(this.onerror=a)},set onSuccess(a){"function"==typeof a&&(this.onsuccess=a)},ontimeout:function(a){console.error("xhr.ontimeout",a)},onerror:function(a){console.error("xhr.onerror!",a)},onsuccess:function(a,b,c,d){console.debug("xhr.onsuccess",a,b,c,d)},isOnline:function(){var a=navigator&&navigator.connection?navigator.connection.type:"NULL";return""===a||"NULL"===a?!j&&!!navigator.onLine:"unknown"!==a&&"none"!==a},set isonline(a){"function"==typeof a&&(this.isOnline=a)},isOn:function(){return!(!t||s)||(1==s&&(s=!1),r?(r=null,!0):!!r)},oneOn:function(){return r=!r,!0},oneOff:function(){s=!0},set alwaysOn(a){t=!!a},set off(a){u="boolean"==typeof a&&a},get off(){return u},dbFirstFalseForNextCall:function(){!0===i&&(v=!0)},isDbFirst:function(){return(!1!==i||!1!==v)&&(!0===i&&!1===v||(!0===i&&!0===v?(v=!1,!1):i))},set maxSyncAttempts(a){"number"==typeof a&&(w=a||w)},get maxSyncAttempts(){return w},set autoRemoveAfterReachMaxAttemps(a){"boolean"==typeof a&&(x=a||x)},get autoRemoveAfterReachMaxAttemps(){return x},set autoSync(a){"boolean"==typeof a&&(y=a)},get autoSync(){return y},ondbprefixchange:function(a,b){C(a,b)},set onDbPrefixChange(a){"function"==typeof a&&(this.ondbprefixchange=a)},set dbPrefix(a){if("string"==typeof a){var b=B;B=a,this.ondbprefixchange(b,B)}},get dbPrefix(){return B},set offlineDBName(a){"string"==typeof a&&(z=a)},get module(){return E},set module(a){if(!a)throw new Error("provide module implementation");E=a},get Module(){return E},set Module(a){if(!a)throw new Error("provide module implementation");E=a},get offlineDBName(){return z},set syncLogDBName(a){"string"==typeof a&&(A=a)},get syncLogDBName(){return A},set Policies(a){N(a)},get Policies(){return L},get DefaultPolicies(){return M},setUrlCache:U,getUrlCache:V,get isCordova(){return j},deviceReady:e,reset:function(){o=[],L.policies=[]},get isTest(){return D},set isTest(a){D=a}}}function p(a,b){"use strict";function c(a){!0!==b.off&&!0!==b.isTest||(m={autosave:!1,autosaveInterval:31104e6,autoload:!1});var c=l||a||b.offlineDBName||"offline";k=new loki(c,m),k.loadDatabase()}function d(a){var b=k.getCollection(a);if(!b){var c={clone:!0,disableChangesApi:!0,transactional:!0};b=k.addCollection(a,c)}return b}function e(a){return new Promise(function(b){k.loadDatabase({},function(){var c=k.getCollection(a);if(!c){c=k.addCollection(a)}b(c)})})}function f(){k.save()}function g(){return k.listCollections()}function h(){return k}function i(a){k.close(a)}function j(){for(var a=g(),b=0;b<a.length;b++)d(a[b].name).removeDataOnly();return!0}var k=null,l=a,m={autosave:!0,autosaveInterval:500,autoload:!0};if(b.isCordova)if("function"==typeof LokiCordovaFSAdapter){var n=new LokiCordovaFSAdapter({prefix:"loki"});m.adapter=n}else console.warn("LokiCordovaFSAdapter is not installed");return b.isCordova?b.deviceReady(function(){c()}):b.ready(c),{getDB:h,getCollection:e,getCollectionByName:d,getCollections:g,save:f,close:i,flush:function(){return new Promise(function(a){a(j())})}}}function q(a,c,d){"use strict";function e(a){return a&&(a=o.clone(a),delete a.$loki,delete a[h],delete a[i],delete a.meta),a}function f(a,b){var c={};c[h]=b.data[h];var d=a.findOne(c);if(d)return o.extendOwn(d,b.data),d[h]=o.stringStartsWith(b.headers[j],"/")?b.headers[j]:"/"+b.headers[j],a.update(d);throw new Error("the payload was not found in collection:"+c[h])}function g(b){if(console.info("Persistence.MCS.flush()",b),o.isEmpty(b))return n.flush();var c=a.parseURL(b),e=d.isPersistUrl(c.path);return new Promise(function(a,b){if(e){var f=d.extractKeyValuesFromUrl2(e);a(n.getCollectionByName(f.root).removeDataOnly())}else b(new Error("Persistence.MCS.flush() given URI not configured for persistence: "+c.path))})}var h="$mcs$mcsPersistenceURI",i="$mcs$etag",j="location",k="oracle-mobile-sync-resource-type",l="mcs",m=a.dbPrefix,n=p(m+"."+l,a);a.onDbPrefixChange=function(b,c){n=p(c+"."+l,a)};var o=c,q=function(a){if(!a)throw new Error("request cannot be undefined or null value");if(!o.isObject(a))throw new Error("request has to be defined object with properties like: url, data etc.");if(o.isEmpty(a))throw new Error("request cannot be empty object, it request properties like: url, data etc.");if(o.isArray(a)||o.isFunction(a))throw new Error("request cannot be array or function");if(!1 in a)throw new Error("request.url was not specified");return!0},r=function(a){if(q(a),o.isEmpty(a.data))throw new Error("cannot proceed with empty payload");if(!1 in a.data)throw new Error("items is not in the payload returned from MCS, probably not Sync Custom Code");if(!1 in a.data)throw new Error("url is not in the payload returned from MCS, probably not Sync Custom Code");if(!1 in a.data)throw new Error("etags is not in the payload returned from MCS, probably not Sync Custom Code");return!0},s=function(a){if(q(a),!1 in a)throw new Error("request.data was not defined!");if(!o.isObject(a.data))throw new Error("request.data is not a object or array!");if(o.isFunction(a.data))throw new Error("request.data cannot be function");return!0},t=function(a){return!!("meta"in a&&a.meta.hasOwnProperty("offline-persist"))},u=function(a,b){return b?(t(a)&&delete a.meta["offline-persist"],a):"meta"in a?(a.meta["offline-persist"]=!0,a):(a.meta={},a.meta["offline-persist"]=!0,a)},v=function(a,c){for(var d=c.items.length,e=Date.now(),f=0;f<d;f++){var g=c.items[f];g[h]=b((o.stringStartsWith(c.uris[f],"/")?"":"/")+c.uris[f]).path,g[i]=c.etags[f];var j={};j[h]=g[h];var k=a.findOne(j);k?(o.extendOwn(k,g),a.update(k)):a.insert(g)}return a.removeWhere(function(a){return a.meta.updated<e}),a.find()},w=function(a,b,c){var d={};d[h]=c;var e=a.findOne(d);if(e){var f=b;return o.extendOwn(e,f),a.update(e)}var f=b;return f[h]=c,a.insert(f)},x=function(b){var c=a.isPersistentUrl(b.url);if(!1===c)throw new Error("Persistence.handleMcsGet()-> URI was not configured for persistence:"+b.url);var d=n.getCollectionByName(c.root);if(o.isEmpty(c.params)){var f=d.find(),g={items:[],uris:[],etags:[]};for(var j in f)f.hasOwnProperty(j)&&(f[j].hasOwnProperty(h)&&g.uris.push(f[j][h]),f[j].hasOwnProperty(i)&&g.etags.push(f[j][i]),g.items.push(e(f[j])));return g}var k={};return k[h]=c.path,e(d.findOne(k))},y=function(b){var c=a.isPersistentUrl(b.url);if(!1===c)throw new Error("Persistence.handleMcsGetStore()-> URI was not configured for persistence:"+b.url);var d=n.getCollectionByName(c.root),e=b.data,f=k in b||b.headers[k];if("collection"===f)return v(d,e);if("item"===f)return w(d,e,c.path);throw f?(console.error("unknown Oracle-Mobile-Sync-Resource-Type (%s)",f),new Error("unknown Oracle-Mobile-Sync-Resource-Type")):(console.error("this is not MCS response, unable to handle the payload, no MCS header was specified: ",b),new Error("this is not MCS response, unable to handle the payload, no MCS header was specified"))},z=function(b,c){var d=a.isPersistentUrl(b.url);if(!1===d)throw new Error("Persistence.handleMcsPost()-> URI was not configured for persistence:"+b.url);var e=n.getCollectionByName(d.root),g=b.data;if(!o.isEmpty(d.params))throw new Error("you can add new objects only against the root REST resource endpoint");if(o.isArray(g))throw new Error("the payload cannot be array");if(o.isObject(g)&&!o.isNull(g)&&!o.isFunction(g)){if(b.data&&b.data[h])return f(e,b);var k=null;b&&b.headers&&b.headers[j]&&(k=o.stringStartsWith(b.headers[j],"/")?b.headers[j]:"/"+b.headers[j]);var l=null;if(k){var m={};m[h]=k,l=e.findOne(m)}if(l?o.extendOwn(l,b.data):(g[i]='"0-1B2M2Y8AsgTpgAmY7PhCfg"',l=e.insert(g),u(l,c)),!k){var p=d.tokens.length>0&&/^\w+$/.test(d.tokens[0].name)?d.tokens[0].name:null,q=null;p&&(q=b.data.hasOwnProperty(p)?b.data[p]:o.getUID()),k=null===q?d.root+"/"+o.getUID():d.root+"/"+q}return l[h]=k,e.update(l)}throw new Error("don't know what to do with the payload")},A=function(b,c){var d=a.isPersistentUrl(b.url);if(!1===d)throw new Error("Persistence.handleMcsPut()-> URI was not configured for persistence:"+b.url);var e=n.getCollectionByName(d.root),f=b.data;if(!o.isEmpty(d.params)){if(o.isArray(f))throw new Error("the payload cannot be array");if(o.isObject(f)&&!o.isNull(f)&&!o.isFunction(f)){var g={};g[h]=d.path;var i=e.findOne(g);if(i)return o.extendOwn(i,f),u(i,c),e.update(i)}}throw new Error("you can execute update operations only against existing items in the offline database!")},B=function(b){var c=a.isPersistentUrl(b.url);if(!1===c)throw new Error("Persistence.handleMcsDelete()-> URI was not configured for persistence:"+b.url);var d=n.getCollectionByName(c.root);b.data;if(!o.isEmpty(c.params)){var e={};e[h]=c.path;var f=d.findOne(e);if(f)return d.remove(f);throw new Error("unable to find object with the given ID(%s) in the database",b.url)}};this.postSuccessOperations=function(b){if("POST"===b.syncObj.method||"PUT"===b.syncObj.method){var c=o.clone(b),e=a.isPersistentUrl(c.syncObj.url);if(!1===e||e.isPolicy("noCache",!0))return void console.debug("sync post success operation exist");var f=c.response;o.isString(f)&&(f=JSON.parse(f)),f=o.extendOwn(c.syncObj.data,f);var g=d.parseResponseHeaders(c.headers),h={url:c.syncObj.url,data:f,method:e.isPolicy("fetchPolicy","FETCH_FROM_CACHE_SCHEDULE_REFRESH")?"PUT":c.syncObj.method,headers:g};a.Module.router(h,!0).catch(function(a){console.error(a)})}return f},this.get=function(a){var b=function(a){console.info("Persistence.MCS.get()"),q(a);var b=o.clone(a);return!b.hasOwnProperty("data")||o.isEmpty(b.data)?o.clone(x(b)):(r(a),o.clone(y(b)))};return new Promise(function(c){c(b(a))})},this.post=function(a,b){var c=function(b,c){console.info("Persistence.MCS.post()"),s(a);var d=o.clone(a);return o.clone(z(d,c))};return new Promise(function(d){d(c(a,b))})},this.put=function(a,b){var c=function(b,c){console.info("Persistence.MCS.put()"),s(a);var d=o.clone(a);return o.clone(A(d,c))};return new Promise(function(d){d(c(a,b))})},this.delete=function(a,b){var c=function(b,c){console.info("Persistence.MCS.delete()"),q(a);var d=o.clone(a);return o.clone(B(d,c))};return new Promise(function(d){d(c(a,b))})},this.router=function(a,b){var c=this;return new Promise(function(e){if(!o.isObject(a))throw console.error("Passed object is not defined request!",a),new Error("Passed object is not defined request!");if(!a.hasOwnProperty("method"))throw console.error("request.method was not provided!",a),new Error("request.method was not provided!");var f=o.clone(a);if(f.method=d.normalizeMethod(f.method),!c[f.method])throw console.error("specified router is not implemented!"),new Error("specified router is not implemented!");e(c[f.method](f,b))})},this.data=function(b){function c(b){var c=a.isPersistentUrl(b);if(!c)throw new Error("Persistence.BaseModule.data() given URI not configured for persistence: "+b);return n.getCollectionByName(c.root)}return new Promise(function(a){a(c(b))})},this.flush=g,this.getModuleName=function(){return"MCS"},this.URI_KEY=h,this.ETAG_KEY=i}function r(a,b,c){"use strict";function d(a){var b="";if(a.attr.length>1)for(var c=1;c<a.attr.length;c++)a.attr[c].is?b.length>0?b+="."+a.attr[c].name:b+=a.attr[c].name:b.length>0?b+="."+a.attr[c].name+"["+a.attr[c].value+"]":b+=a.attr[c].value;return b}function e(a,d,e){var f=[],g=d.attr;if(Array.isArray(g)&&g.length>0)for(var h=a.uri.tokens.length>1?a.uri.tokens.slice(1):[],i=0;i<g.length;i++){var j=g.length-1==i;if(g[i].is){if(f.push({name:g[i].name,value:null,isProperty:!0,isInteger:!1}),j&&h[i+1]&&e){var k=c.isUrlRegexInteger(h[i+1].pattern);f.push({name:h[i+1].name,value:k?b.getUID():b.getUID()+"",isProperty:!1,isInteger:k})}}else{var l=g[i].value||b.getUID();f.push({name:g[i].name,value:l,isProperty:!1,isInteger:c.isUrlRegexInteger(h[i].pattern)})}}return f}function f(a,b,d,f,h){var i=e(b,d),j=a;if(Array.isArray(i)&&i.length>0){var k;if(h){var l=g(b,d);k={key:l,value:h[l.name]}}j=c.setNestedProperty2(a,i,f,k)}else n.extendOwn(a,f);return{obj:a,result:j}}function g(a,b){var c=b.attr.length;return a.uri.tokens[c+1]}function h(a,b,d,f){var g=e(b,d,!1),h=a;return Array.isArray(g)&&g.length>0&&(h=c.setNestedProperty2(a,g,f)),{obj:a,result:h}}function i(a,b,d){var f=e(b,d,!1);return Array.isArray(f)&&f.length>0?c.getNestedProperty(a,f):a}function j(b){if(console.info("Persistence.RequestHandler.flush()",b),n.isEmpty(b))return m.flush();var d=a.parseURL(b),e=c.isPersistUrl(d.path);return new Promise(function(a,b){if(e){var f=c.extractKeyValuesFromUrl2(e);a(m.getCollectionByName(f.root).removeDataOnly())}else b(new Error("Persistence.RequestHandler.flush() given URI not configured for persistence: "+d.path))})}var k="request",l=a.dbPrefix,m=p(l+"."+k,a);a.onDbPrefixChange=function(b,c){m=p(c+"."+k,a)};var n=b,o=function(a){if(!a)throw new Error("request cannot be undefined or null value");if(!n.isObject(a))throw new Error("request has to be defined object with properties like: url, data etc.");if(n.isEmpty(a))throw new Error("request cannot be empty object, it request properties like: url, data etc.");if(n.isArray(a)||n.isFunction(a))throw new Error("request cannot be array or function");if(!1 in a)throw new Error("request.url was not specified");return!0},q=function(a){return o(a),!0},r=function(a){if(o(a),!1 in a)throw new Error("request.data was not defined!");if(!n.isObject(a.data))throw new Error("request.data is not a object or array!");if(n.isFunction(a.data))throw new Error("request.data cannot be function");return!0},s=function(a){return!!("meta"in a&&a.meta.hasOwnProperty("offline-persist"))},t=function(a){return!(!("$loki"in a&&"number"==typeof a.$loki)||isNaN(a.$loki))},u=function(a){var b={};if(a.attr.length>0){b[a.attr[0].name]=a.attr[0].pattern.indexOf("d")>=0?parseInt(a.attr[0].value):a.attr[0].value+""}return b},v=function(a,b){var c=function(){return a.uri.tokens.length>1&&a.uri.tokens[a.uri.tokens.length-1].pattern.indexOf("d")>=0},d=function(a){return c()?parseInt(a):a+""};return n.isEmpty(b)?d(n.getUID()):"number"==typeof b&&c()?b:d(b)},w=function(a,b,c){if(b.uri.tokens.length>1){if(c.find().length>0){var d=b.uri.tokens[1].name;return c.removeWhere(function(b){var e=a.findIndex(function(a){return a[d]===b[d]});if(!(e>-1))return!s(b);try{s(b)?b=n.deepExtend(a[e],b):n.extendOwn(b,a[e]),c.update(b),a.splice(e,1)}catch(f){console.error(f)}finally{return!1}}),a.forEach(function(a){t(a)?c.update(a):c.insert(a)}),c.find()}return c.insert(a)}return c.removeWhere(function(a){return!s(a)}),c.insert(a)},x=function(a,b,c){if(b.uri.tokens.length>1){var d=b.uri.tokens[1].name;if(!a.hasOwnProperty(d))throw console.error("payload does not contain unique key specified in the URL settings"),new Error("payload does not contain unique key specified in the URL settings");var e={};e[d]=a[d];var f=c.findOne(e);return f?(s(f)?f=n.deepExtend(a,f):n.extendOwn(f,a),c.update(f)):c.insert(a)}return c.removeWhere(function(a){return!s(a)}),c.insert(a)},y=function(a,b){return b?(s(a)&&delete a.meta["offline-persist"],a):"meta"in a?(a.meta["offline-persist"]=!0,a):(a.meta={},a.meta["offline-persist"]=!0,a)},z=function(b){var d=a.parseURL(b.url),e=c.isPersistUrl(d.path)
;if(!e)throw new Error("Persistence.RequestHandler.get() given URI was not configured for persistence:"+d.path);var f=c.extractKeyValuesFromUrl2(e),g=m.getCollectionByName(f.root),h=(b.data,u(f));if(!n.isEmpty(h)){var j=g.findOne(h);return j?n.cleanObject(i(j,e,f)):[]}return console.info("unable to build find query for given url and payload, return all from db"),n.cleanObjects(g.find())},A=function(b){var d=a.parseURL(b.url),e=c.isPersistUrl(d.path);if(!e)throw new Error("Persistence.RequestHandler.get() given URI was not configured for persistence:"+d.path);var f=c.extractKeyValuesFromUrl2(e),g=m.getCollectionByName(f.root),i=b.data,j=u(f);if(n.isEmpty(j)){if(!n.isArray(i)||n.isFunction(i)||n.isEmpty(i)){if(!n.isObject(i)||n.isArray(i)||n.isFunction(i)||n.isEmpty(i))throw console.error("Persistence.RequestHandler.get() unknown or empty object passed for the operation"),new Error("Persistence.RequestHandler.get() -> unknown or empty object passed for the operation");return x(i,e,g)}return w(i,e,g)}var k=g.findOne(j);if(k){var l=h(k,e,f,i);return g.update(l.obj),l.result}var l=h(j,e,f,i);return g.insert(l.obj),l.result},B=function(a,b,c,d){var e=b.uri.tokens.length>1?b.uri.tokens[1].name:null;return a.forEach(function(a){if(t(a))y(a,d),c.update(a);else{if(!e||!a.hasOwnProperty(e)){var f=c.insert(a);return f[e]=v(b),y(f,d),n.cleanObject(c.update(f))}var g=c.findOne({keyNameToCompare:a[e]});g?(n.extendOwn(g,a),y(g,d),c.update(g)):(y(a,d),c.insert(a))}}),n.cleanObjects(c.find())},C=function(a,b,c,d){var e=b.uri.tokens.length>1?b.uri.tokens[1].name:"";if(e&&!a.hasOwnProperty(e)){console.info("get payload","does not have the key specified in the URL settings"),a[e]="";var f=c.insert(a);if(f)return f[e]=v(b),y(f,d),n.cleanObject(c.update(f));throw new Error("unable to store the payload object")}if(e&&a.hasOwnProperty(e)){var g={};g[e]=a[e];var h=c.findOne(g);if(h)return n.extendOwn(h,a),y(h,d),n.cleanObject(c.update(h));a[e]=v(b,a[e])}return y(a,d),n.cleanObject(c.insert(a))},D=function(b,d){var e=a.parseURL(b.url),g=c.isPersistUrl(e.path);if(!g)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(g),i=m.getCollectionByName(h.root),j=b.data,k=u(h);if(!n.isEmpty(k)){var l=i.findOne(k);if(l){var o=f(l,g,h,j),p=g.uri.tokens[g.uri.tokens.length-1].name;return o.result[p]=v(g,o.result[p]),y(o.obj,d),i.update(o.obj),n.cleanObject(o.result)}var o=f(k,g,h,j);return y(o.obj,d),i.insert(o.obj),n.cleanObject(o.result)}if(n.isArray(j))return B(j,g,i,d);if(n.isObject(j)&&!n.isArray(j)&&!n.isNull(j))return C(j,g,i,d);throw new Error("don't know what to do with the payload")},E=function(b,d){var e=a.parseURL(b.url),g=c.isPersistUrl(e.path);if(!g)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(g),i=m.getCollectionByName(h.root),j=b.data,k=u(h);if(!n.isEmpty(k)){var l=i.findOne(k);if(l){var o=f(l,g,h,j);return y(o.obj,d),i.update(o.obj),o.result}var o=f(k,g,h,j);return y(o.obj,d),i.insert(o.obj),o.result}if(n.isArray(j))return B(j,g,i,d);if(n.isObject(j)&&!n.isArray(j)&&!n.isNull(j))return C(j,g,i,d);throw new Error("no key specified to recognise obj in the database for editing!")},F=function(b,d){var e=a.parseURL(b.url),g=c.isPersistUrl(e.path);if(!g)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(g),i=m.getCollectionByName(h.root),j=b.data,k=u(h);if(!n.isEmpty(k)){var l=i.findOne(k);if(l){var o=f(l,g,h,j);return y(o.obj,d),i.update(o.obj),o.result}var o=f(k,g,h,j);return y(o.obj,d),i.insert(o.obj),o.result}if(n.isArray(j))return B(j,g,i,d);if(n.isObject(j)&&!n.isArray(j)&&!n.isNull(j))return C(j,g,i,d);throw new Error("no key specified to recognise obj in the database for editing!")},G=function(b){var d=a.parseURL(b.url),e=c.isPersistUrl(d.path);if(!e)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+d.path);var f=c.extractKeyValuesFromUrl2(e),g=m.getCollectionByName(f.root),h=u(f);if(!n.isEmpty(h)){var i=g.findOne(h);if(i)return n.cleanObject(g.remove(i));throw new Error("unable to find object with the given ID(%s) in the database",h)}if(b.hasOwnProperty("data")){var j=b.data;if(!n.isEmpty(j)&&n.isObject(j)&&!n.isArray(j)){var k=e.uri.tokens.length>1?e.uri.tokens[1].name:null;if(k&&!b.data.hasOwnProperty(k))throw new Error("payload does not have the key required to delete the object");var i=g.findOne({keyNameToCompare:b.data[k]});if(i)return n.cleanObject(g.remove(i))}}throw console.error("payload does not have the key required to delete the object in the payload"),new Error("payload does not have the key required to delete the object in the payload")};this.postSuccessOperations=function(b){if("POST"===b.syncObj.method){var d=n.clone(b),e=a.parseURL(d.syncObj.url),g=c.isPersistUrl(e.path);if(!g)return console.debug("sync post success operation exist"),b;var h=c.extractKeyValuesFromUrl2(g),i=m.getCollectionByName(h.root),j=d.syncObj.data,k=d.response,l=u(h);if(n.isEmpty(l)){var o=g.uri.tokens.length>1?g.uri.tokens[1].name:"";if(o&&!j.hasOwnProperty(o))return k=n.extendOwn(j,k),n.cleanObject(i.insert(k));var p={};p[o]=j[o];var q=i.findOne(p);return n.extendOwn(q,k),n.cleanObject(i.update(q))}var r=i.findOne(l);if(r){var q=f(r,g,h,k,j),s=g.uri.tokens[g.uri.tokens.length-1].name;return q.result[s]=v(g,q.result[s]),i.update(q.obj),n.cleanObject(q.result)}var t=f(l,g,h,k);return i.insert(t.obj),n.cleanObject(t.result)}return b},this.getDB=function(){return m},this.get=function(a){var b=function(a){console.info("Persistence.RequestHandler.get()"),q(a);var b=n.clone(a);return!b.hasOwnProperty("data")||n.isEmpty(b.data)?n.clone(z(b)):n.clone(A(b))};return new Promise(function(c){c(b(a))})},this.post=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.post()"),r(a);var c=n.clone(a);return n.clone(D(c,b))};return new Promise(function(d){d(c(a,b))})},this.put=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.put()"),r(a);var c=n.clone(a);return n.clone(E(c,b))};return new Promise(function(d){d(c(a,b))})},this.patch=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.patch()"),r(a);var c=n.clone(a);return n.clone(F(c,b))};return new Promise(function(d){d(c(a,b))})},this.delete=function(a){function b(a){console.info("Persistence.RequestHandler.delete()"),o(a);var b=n.clone(a);return n.clone(G(b))}return new Promise(function(c){c(b(a))})},this.data=function(b){function d(b){if(console.info("Persistence.RequestHandler.data()"),null==b)throw new Error("Path cannot be empty!");var d=a.parseURL(b),e=c.isPersistUrl(d.path);if(!e)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+d.path);var f=c.extractKeyValuesFromUrl2(e);return m.getCollectionByName(f.root)}return new Promise(function(a){a(d(b))})},this.router=function(a,b){var d=this;return new Promise(function(e){if(!q(a))throw console.error("Passed object is not defined request for GET!",a.url),new Error("Passed object is not defined request for GET!");if(!a.hasOwnProperty("method"))throw console.error("request.method was not provided!",a),new Error("request.method was not provided!");var f=n.clone(a);if(f.method=c.normalizeMethod(f.method),!d[f.method])throw console.error("specified router is not implemented!"),new Error("specified router is not implemented!");e(d[f.method](f,b))})},this.flush=j,this.getModuleName=function(){return"MCS"},this._createObjFromUrlParamsForExistingForPost=f,this._buildNestedPropertyAddString=e,this._buildNestedPropertySearchString=d,this._createObjFromUrlParamsForExisting=h,this._buildNestedPropertyArrayParams=e}function s(a,b,c){"use strict";function d(a){return o.isArray(a)?{items:a}:a}function e(a){var b="";if(a.attr.length>1)for(var c=1;c<a.attr.length;c++)a.attr[c].is?b.length>0?b+="."+a.attr[c].name:b+=a.attr[c].name:b.length>0?b+="."+a.attr[c].name+"["+a.attr[c].value+"]":b+=a.attr[c].value;return b}function f(a,d,e){var f=[],g=d.attr;if(Array.isArray(g)&&g.length>0)for(var h=a.uri.tokens.length>1?a.uri.tokens.slice(1):[],i=0;i<g.length;i++){var j=g.length-1==i;if(g[i].is){if(f.push({name:g[i].name,value:null,isProperty:!0,isInteger:!1}),j&&h[i+1]&&e){var k=c.isUrlRegexInteger(h[i+1].pattern);f.push({name:h[i+1].name,value:k?b.getUID():b.getUID()+"",isProperty:!1,isInteger:k})}}else{var l=g[i].value||b.getUID();f.push({name:g[i].name,value:l,isProperty:!1,isInteger:c.isUrlRegexInteger(h[i].pattern)})}}return f}function g(a,b,d,e,g){var i=f(b,d),j=a;if(Array.isArray(i)&&i.length>0){var k;if(g){var l=h(b,d);k={key:l,value:g[l.name]}}j=c.setNestedProperty2(a,i,e,k)}else o.extendOwn(a,e);return{obj:a,result:j}}function h(a,b){var c=b.attr.length;return a.uri.tokens[c+1]}function i(a,b,d,e){var g=f(b,d,!1),h=a;return Array.isArray(g)&&g.length>0&&(h=c.setNestedProperty2(a,g,e)),{obj:a,result:h}}function j(a,b,d){var e=f(b,d,!1);return Array.isArray(e)&&e.length>0?c.getNestedProperty(a,e):a}function k(b){if(console.info("Persistence.RequestHandler.flush()",b),o.isEmpty(b))return n.flush();var d=a.parseURL(b),e=c.isPersistUrl(d.path);return new Promise(function(a,b){if(e){var f=c.extractKeyValuesFromUrl2(e);a(n.getCollectionByName(f.root).removeDataOnly())}else b(new Error("Persistence.RequestHandler.flush() given URI not configured for persistence: "+d.path))})}var l="oraclerest",m=a.dbPrefix,n=p(m+"."+l,a);a.onDbPrefixChange=function(b,c){n=p(c+"."+l,a)};var o=b,q=function(a){if(!a)throw new Error("request cannot be undefined or null value");if(!o.isObject(a))throw new Error("request has to be defined object with properties like: url, data etc.");if(o.isEmpty(a))throw new Error("request cannot be empty object, it request properties like: url, data etc.");if(o.isArray(a)||o.isFunction(a))throw new Error("request cannot be array or function");if(!1 in a)throw new Error("request.url was not specified");return!0},r=function(a){return q(a),!0},s=function(a){if(q(a),!1 in a)throw new Error("request.data was not defined!");if(!o.isObject(a.data))throw new Error("request.data is not a object or array!");if(o.isFunction(a.data))throw new Error("request.data cannot be function");return!0},t=function(a){return!!("meta"in a&&a.meta.hasOwnProperty("offline-persist"))},u=function(a){return!(!("$loki"in a&&"number"==typeof a.$loki)||isNaN(a.$loki))},v=function(a){var b={};if(a.attr.length>0){b[a.attr[0].name]=a.attr[0].pattern.indexOf("d")>=0?parseInt(a.attr[0].value):a.attr[0].value+""}return b},w=function(a,b){var c=function(){return a.uri.tokens.length>1&&a.uri.tokens[a.uri.tokens.length-1].pattern.indexOf("d")>=0},d=function(a){return c()?parseInt(a):a+""};return o.isEmpty(b)?d(o.getUID()):"number"==typeof b&&c()?b:d(b)},x=function(a,b,c){if(b.uri.tokens.length>1){if(c.find().length>0){var d=b.uri.tokens[1].name;return c.removeWhere(function(b){var e=a.findIndex(function(a){return a[d]===b[d]});if(!(e>-1))return!t(b);try{t(b)?b=o.deepExtend(a[e],b):o.extendOwn(b,a[e]),c.update(b),a.splice(e,1)}catch(f){console.error(f)}finally{return!1}}),a.forEach(function(a){u(a)?c.update(a):c.insert(a)}),c.find()}return c.insert(a)}return c.removeWhere(function(a){return!t(a)}),c.insert(a)},y=function(a,b,c){if(b.uri.tokens.length>1){var d=b.uri.tokens[1].name;if(!a.hasOwnProperty(d))throw console.error("payload does not contain unique key specified in the URL settings"),new Error("payload does not contain unique key specified in the URL settings");var e={};e[d]=a[d];var f=c.findOne(e);return f?(t(f)?f=o.deepExtend(a,f):o.extendOwn(f,a),c.update(f)):c.insert(a)}return c.removeWhere(function(a){return!t(a)}),c.insert(a)},z=function(a,b){return b?(t(a)&&delete a.meta["offline-persist"],a):"meta"in a?(a.meta["offline-persist"]=!0,a):(a.meta={},a.meta["offline-persist"]=!0,a)},A=function(b){var e=a.parseURL(b.url),f=c.isPersistUrl(e.path);if(!f)throw new Error("Persistence.RequestHandler.get() given URI was not configured for persistence:"+e.path);var g=c.extractKeyValuesFromUrl2(f),h=n.getCollectionByName(g.root),i=(b.data,v(g));if(o.isEmpty(i))return console.info("unable to build find query for given url and payload, return all from db"),d(o.cleanObjects(h.find()));var k=h.findOne(i);if(k){var l=j(k,f,g);return d(o.cleanObject(l))}return null},B=function(b){var e=a.parseURL(b.url),f=c.isPersistUrl(e.path);if(!f)throw new Error("Persistence.RequestHandler.get() given URI was not configured for persistence:"+e.path);var g=c.extractKeyValuesFromUrl2(f),h=n.getCollectionByName(g.root),j=b.data.items||b.data,k=v(g);if(o.isEmpty(k)){if(j=b.data.items,!o.isArray(j)||o.isFunction(j)||o.isEmpty(j)){if(!o.isObject(j)||o.isArray(j)||o.isFunction(j)||o.isEmpty(j))throw console.error("Persistence.OracleRESTHandler.get() unknown or empty object passed for the operation"),new Error("Persistence.OracleRESTHandler.get() -> unknown or empty object passed for the operation");return y(j,f,h)}return d(x(j,f,h))}var l,m=h.findOne(k);return m?(l=i(m,f,g,j),h.update(l.obj)):(l=i(k,f,g,j),h.insert(l.obj)),d(l.result)},C=function(a,b,c,d){var e=b.uri.tokens.length>1?b.uri.tokens[1].name:null;return a.forEach(function(a){if(u(a))z(a,d),c.update(a);else{if(!e||!a.hasOwnProperty(e)){var f=c.insert(a);return f[e]=w(b),z(f,d),o.cleanObject(c.update(f))}var g=c.findOne({keyNameToCompare:a[e]});g?(o.extendOwn(g,a),z(g,d),c.update(g)):(z(a,d),c.insert(a))}}),o.cleanObjects(c.find())},D=function(a,b,c,d){var e=b.uri.tokens.length>1?b.uri.tokens[1].name:"";if(e&&!a.hasOwnProperty(e)){console.info("get payload","does not have the key specified in the URL settings"),a[e]="";var f=c.insert(a);if(f)return f[e]=w(b),z(f,d),o.cleanObject(c.update(f));throw new Error("unable to store the payload object")}if(e&&a.hasOwnProperty(e)){var g={};g[e]=a[e];var h=c.findOne(g);if(h)return o.extendOwn(h,a),z(h,d),o.cleanObject(c.update(h));var i=w(b,a[e]);a[e]=i}return z(a,d),o.cleanObject(c.insert(a))},E=function(b,d){var e=a.parseURL(b.url),f=c.isPersistUrl(e.path);if(!f)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(f),i=n.getCollectionByName(h.root),j=b.data,k=v(h);if(!o.isEmpty(k)){var l=i.findOne(k);if(l){var m=g(l,f,h,j),p=f.uri.tokens[f.uri.tokens.length-1].name;return m.result[p]=w(f,m.result[p]),z(m.obj,d),i.update(m.obj),o.cleanObject(m.result)}var m=g(k,f,h,j);return z(m.obj,d),i.insert(m.obj),o.cleanObject(m.result)}if(o.isArray(j))return C(j,f,i,d);if(o.isObject(j)&&!o.isArray(j)&&!o.isNull(j))return D(j,f,i,d);throw new Error("don't know what to do with the payload")},F=function(b,d){var e=a.parseURL(b.url),f=c.isPersistUrl(e.path);if(!f)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(f),i=n.getCollectionByName(h.root),j=b.data,k=v(h);if(!o.isEmpty(k)){var l=i.findOne(k);if(l){var m=g(l,f,h,j);return z(m.obj,d),i.update(m.obj),m.result}var m=g(k,f,h,j);return z(m.obj,d),i.insert(m.obj),m.result}if(o.isArray(j))return C(j,f,i,d);if(o.isObject(j)&&!o.isArray(j)&&!o.isNull(j))return D(j,f,i,d);throw new Error("no key specified to recognise obj in the database for editing!")},G=function(b,d){var e=a.parseURL(b.url),f=c.isPersistUrl(e.path);if(!f)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+e.path);var h=c.extractKeyValuesFromUrl2(f),i=n.getCollectionByName(h.root),j=b.data,k=v(h);if(!o.isEmpty(k)){var l=i.findOne(k);if(l){var m=g(l,f,h,j);return z(m.obj,d),i.update(m.obj),m.result}var m=g(k,f,h,j);return z(m.obj,d),i.insert(m.obj),m.result}if(o.isArray(j))return C(j,f,i,d);if(o.isObject(j)&&!o.isArray(j)&&!o.isNull(j))return D(j,f,i,d);throw new Error("no key specified to recognise obj in the database for editing!")},H=function(b){var d=a.parseURL(b.url),e=c.isPersistUrl(d.path);if(!e)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+d.path);var f=c.extractKeyValuesFromUrl2(e),g=n.getCollectionByName(f.root),h=v(f);if(!o.isEmpty(h)){var i=g.findOne(h);if(i)return o.cleanObject(g.remove(i));throw new Error("unable to find object with the given ID(%s) in the database",h)}if(b.hasOwnProperty("data")){var j=b.data;if(!o.isEmpty(j)&&o.isObject(j)&&!o.isArray(j)){var k=e.uri.tokens.length>1?e.uri.tokens[1].name:null;if(k&&!b.data.hasOwnProperty(k))throw new Error("payload does not have the key required to delete the object");var i=g.findOne({keyNameToCompare:b.data[k]});if(i)return o.cleanObject(g.remove(i))}}throw console.error("payload does not have the key required to delete the object in the payload"),new Error("payload does not have the key required to delete the object in the payload")};this.postSuccessOperations=function(b){if("POST"===b.syncObj.method){var d=o.clone(b),e=a.parseURL(d.syncObj.url),f=c.isPersistUrl(e.path);if(!f)return console.debug("sync post success operation exist"),b;var h=c.extractKeyValuesFromUrl2(f),i=n.getCollectionByName(h.root),j=d.syncObj.data,k=d.response,l=v(h);if(o.isEmpty(l)){var m=f.uri.tokens.length>1?f.uri.tokens[1].name:"";if(m&&!j.hasOwnProperty(m))return k=o.extendOwn(j,k),o.cleanObject(i.insert(k));var p={};p[m]=j[m];var q=i.findOne(p);return o.extendOwn(q,k),o.cleanObject(i.update(q))}var r=i.findOne(l);if(r){var q=g(r,f,h,k,j),s=f.uri.tokens[f.uri.tokens.length-1].name;return q.result[s]=w(f,q.result[s]),i.update(q.obj),o.cleanObject(q.result)}var t=g(l,f,h,k);return i.insert(t.obj),o.cleanObject(t.result)}return b},this.getDB=function(){return n},this.get=function(a){var b=function(a){console.info("Persistence.RequestHandler.get()"),r(a);var b=o.clone(a);return!b.hasOwnProperty("data")||o.isEmpty(b.data)?o.clone(A(b)):o.clone(B(b))};return new Promise(function(c){c(b(a))})},this.post=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.post()"),s(a);var c=o.clone(a);return o.clone(E(c,b))};return new Promise(function(d){d(c(a,b))})},this.put=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.put()"),s(a);var c=o.clone(a);return o.clone(F(c,b))};return new Promise(function(d){d(c(a,b))})},this.patch=function(a,b){var c=function(a,b){console.info("Persistence.RequestHandler.patch()"),s(a);var c=o.clone(a);return o.clone(G(c,b))};return new Promise(function(d){d(c(a,b))})},this.delete=function(a){function b(a){console.info("Persistence.RequestHandler.delete()"),q(a);var b=o.clone(a);return o.clone(H(b))}return new Promise(function(c){c(b(a))})},this.data=function(b){function d(b){if(console.info("Persistence.RequestHandler.data()"),null==b)throw new Error("Path cannot be empty!");var d=a.parseURL(b),e=c.isPersistUrl(d.path);if(!e)throw new Error("Persistence.RequestHandler.post() given URI not configured for persistence: "+d.path);var f=c.extractKeyValuesFromUrl2(e);return n.getCollectionByName(f.root)}return new Promise(function(a){a(d(b))})},this.router=function(a,b){var d=this;return new Promise(function(e){if(!r(a))throw console.error("Passed object is not defined request for GET!",a.url),new Error("Passed object is not defined request for GET!");if(!a.hasOwnProperty("method"))throw console.error("request.method was not provided!",a),new Error("request.method was not provided!");var f=o.clone(a);if(f.method=c.normalizeMethod(f.method),!d[f.method])throw console.error("specified router is not implemented!"),new Error("specified router is not implemented!");e(d[f.method](f,b))})},this.flush=k,this.getModuleName=function(){return"MCS"},this._createObjFromUrlParamsForExistingForPost=g,this._buildNestedPropertyAddString=f,this._buildNestedPropertySearchString=e,this._createObjFromUrlParamsForExisting=i}function t(){"use strict";var a={},b=3e4,c=12e4,d=null,e=function(b,c,d){if(l(),null==b)throw new Error("event name cannot be null or undefined");if(null==c||"function"!=typeof c)throw new Error("event handler cannot be null or undefined function");var e=window;return null!=d||"boolean"==typeof d?e.addEventListener(b,c,d):e.addEventListener(b,c),a[b]={event:b,element:e,handler:c,capture:d,timestamp:(new Date).getTime()},a[b]},f=function(b){null!=b&&a.hasOwnProperty(b)&&(a[b].element.removeEventListener(a[b].event,a[b].handler,a[b].capture),delete a[b])},g=function(){for(var b in a)a.hasOwnProperty(b)&&"object"==typeof a[b]&&(a[b].element.removeEventListener(a[b].event,a[b].handler,a[b].capture),delete a[b])},h=function(){for(var b in a)a.hasOwnProperty(b)&&console.log("event details: ",a[b])},i=function(){return a},j=function(b){if(a.hasOwnProperty(b)&&"object"==typeof a[b])return a[b]},k=function(b,c,d,e){if(window.CustomEvent&&(a.hasOwnProperty(e)||"object"===(a[e],!1))){var g=new CustomEvent(e,{detail:{status:b,statusText:c,data:d,requestid:e,time:(new Date).getTime()},bubbles:!0,cancelable:!0});setTimeout(function(){try{window.dispatchEvent(g)}catch(a){console.error(a)}finally{setTimeout(function(){f(e)},0)}},0)}},l=function(){var c=b,d=Date.now(),e=i();for(var g in e)if(e.hasOwnProperty(g)){var h=d-a[g].timestamp;c<h&&f(g)}};return{addListener:e,removeListener:f,getListener:j,dispatchEvent:k,removeAllListeners:g,getAllEvents:i,runClearDeamon:function(a,e){a<0?null!=d&&clearInterval(d):0==a?l():(b=a||b,c=e||c,d=setInterval(l,c))},toString:h}}function u(){var a={success:[],error:[],timeout:[]};return{$on:function(b,c){null!==b&&"string"==typeof b&&a.hasOwnProperty(b)&&"function"==typeof c&&a[b].push(c)},$emit:function(b,c){if(null!==b&&"string"==typeof b&&a.hasOwnProperty(b)&&null!==c)for(var d=0;d<a[b].length;d++)a[b][d](c)},$flush:function(b){if(null!==b&&"string"==typeof b&&a.hasOwnProperty(b))for(var c=a[b].length-1;c>=0;c--)a[b].splice(0,1)},$show:function(a){throw new Error("not implemented")}}}function v(){}function w(a,b,c,d,e){"use strict";function f(){this.events={"pre-put":[],"pre-patch":[],"pre-post":[],"pre-get":[],"pre-delete":[],"pre-sync":[],"post-sync":[],"error-sync":[],"end-sync":[]}}function g(a){return L.getCollectionByName(a)}function h(){return F=!0}function i(a){return a||(H=!0),F=!1}function j(){return F}function k(){return N++,!0===j()?N>10?(N=0,-1):0:(N=0,1)}function l(a,b){var d=c.isPersistentUrl(a);if(!1===d)throw console.error("give url not configured for persistence",a),new Error("give url not configured for persistence:"+a);return d}function m(a){if(I.isEmpty(a))throw new Error("sync options is empty object, cannot be synced!");if(!a.hasOwnProperty("url"))throw new Error("options.url was not specified!");if(I.isEmpty(a.url))throw new Error("options.url cannot be empty!");if(!a.hasOwnProperty("headers"))throw new Error("request headers were not specified!");return I.isEmpty(a.data)||(a.data={}),a.method="GET",M.emit("pre-get",a),g().insert(a)}function n(a){O(a);var b=l(a.url);return"$loki"in a&&"number"==typeof a.$loki&&!isNaN(a.$loki)&&delete a.$loki,a.method="POST",a.URI=b.root,M.emit("pre-post",a),g().insert(a)}function o(a){O(a);var b=Q(a),c=g();if(M.emit("pre-put",a),I.isEmpty(b.dbquery))return a.method="PUT",a.URI=b.queryUrl.root,c.insert(a);var d=c.findOne({$and:[b.dbquery,{method:"POST"},{URI:b.queryUrl.root}]});return d?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){o(a)},G),I.extendOwn(d.data,a.data),I.extendOwn(d.headers,a.headers),d.$errorcounter=0,c.update(d)):(d=c.findOne({$and:[b.dbquery,{method:"PUT"},{URI:b.queryUrl.root}]}))?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){o(a)},G),I.extendOwn(d,a),d.$errorcounter=0,c.update(d)):(a.method="PUT",a.URI=b.queryUrl.root,c.insert(a))}function q(a){O(a);var b=Q(a),c=g();if(M.emit("pre-patch",a),I.isEmpty(b.dbquery))return a.method="PATCH",a.URI=b.queryUrl.root,c.insert(a);var d=c.findOne({$and:[b.dbquery,{method:"POST"},{URI:b.queryUrl.root}]});return d?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){o(a)},G),I.extendOwn(d.data,a.data),I.extendOwn(d.headers,a.headers),d.$errorcounter=0,c.update(d)):(d=c.findOne({$and:[b.dbquery,{method:"PATCH"},{URI:b.queryUrl.root}]}))?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){q(a)},G),I.extendOwn(d,a),d.$errorcounter=0,c.update(d)):(a.method="PATCH",a.URI=b.queryUrl.root,c.insert(a))}function r(a){P(a);var b=Q(a);M.emit("pre-delete",a);var c=g();if(I.isEmpty(b.dbquery))return a.method="DELETE",a.URI=b.queryUrl.root,c.insert(a);var d=c.findOne({$and:[b.dbquery,{URI:b.queryUrl.root},{method:{$eq:"POST"}}]});return d?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){r(a)},G),c.remove(d)):(d=c.findOne({$and:[b.dbquery,{URI:b.queryUrl.root},{method:{$eq:"PUT"}}]}))?(E&&!I.isEmpty(E)&&"$loki"in E&&E.$loki===d.$loki&&setTimeout(function(){r(a)},G),d.url=a.url,d.method="DELETE",d.URI=b.queryUrl.root,"data"in a&&(d.data=a.data),d.$errorcounter=0,c.update(d)):(a.method="DELETE",a.URI=b.queryUrl.root,c.insert(a))}function s(a){if(I.isEmpty(a))throw new Error("removeSync(request) is empty cannot be removed from the sync log!");if(!I.isObject(a))throw new Error("removeSync(request) is not a object!");if(!a.hasOwnProperty("url"))throw new Error("request.url was not specified!");if(I.isEmpty(a.url))throw new Error("request.url cannot be empty!");if(!("$loki"in a&&"number"==typeof a.$loki)||isNaN(a.$loki))throw new Error("removeSync(request.$loki) does not exist to be able to be removed from the sync table!");var b=g(),c=b.findOne({$loki:a.$loki});if(c)return b.remove(c)}function t(a,b,c,d){this.name="XhrError",this.message=a||"Error during XHR2 execution",this.status=b||0,this.response=c||"",this.headers=d||{},this.stack=(new Error).stack}function u(b,d,e,f,g,h){return new Promise(function(i,j){c.oneOff();var k=new XMLHttpRequest;"withCredentials"in k&&(k.withCredentials=!0),g&&(k.responseType=g),k.open(b,d,!0);for(var l in e)if(e.hasOwnProperty(l)){var m=e[l];k.setRequestHeader(l,m)}if(!e["Oracle-Mobile-Client-SDK-Info"]){var n=c.isCordova?"Cordova":"Web";n+=" "+(void 0===D?"Unknown":D),n+=" [SyncExpress]",k.setRequestHeader("Oracle-Mobile-Client-SDK-Info",n)}k.timeout=h||c.timeout,k.ontimeout=function(b){console.error("sync.xhr.ontimeout",b),a.$emit("timeout",{event:b}),j(new TypeError("Timeout during XHR load"))},k.onload=function(){k.status>=200&&k.status<400?i(k):j(k)},k.onerror=function(){console.log("sync.xhr.onerror",k),a.$emit("error",{event:k}),j(k)},k.send(f&&void 0!==f&&null!=f&&"DELETE"!==b?JSON.stringify(f):null)})}function w(a,b){var c=b?JSON.parse(JSON.stringify(a)):a;if("data"in c&&null!=c.data&&I.isObject(c.data)&&!I.isEmpty(c.data)){"$loki"in c.data&&"number"==typeof c.data.$loki&&!isNaN(c.data.$loki)&&delete c.data.$loki,"meta"in c.data&&delete c.data.meta;for(var d in c.data)I.stringStartsWith(d,"$mcs$")&&delete c.data[d]}return c}function x(a){if(console.info("Persistence.Sync.flush()",a),I.isEmpty(a))return L.flush();var b=l(a);return new Promise(function(a,c){1==C?c(new Error("unable to proceed with this operation, sync is in process")):a(g(b.root).removeDataOnly())})}function y(){C=!0}function z(){C=!1}function A(){return C}function B(a,b,c){c.then(function(b){i(),a(b)}).catch(function(a){i(!0),console.error(a),b(a)})}var C=!1,E=null,F=!1,G=2e3,H=!1,I=b,J="sync",K=c.dbPrefix,L=p(K+"."+J,c);c.onDbPrefixChange=function(a,b){L=p(b+"."+J,c)},f.prototype=new v;var M=new f,N=0,O=function(a){if(I.isEmpty(a))throw new Error("sync options is empty object, cannot be synced!");if(!a.hasOwnProperty("url"))throw new Error("options.url was not specified!");if(I.isEmpty(a.url))throw new Error("options.url cannot be empty!");if(!a.hasOwnProperty("headers"))throw new Error("options.headers were not specified!");if(!I.isObject(a.headers))throw new Error("options.headers is not a objects!");if(!a.hasOwnProperty("data"))throw new Error("options.data was not specified!");if(I.isEmpty(a.data))throw new Error("options.data cannot be empty object!");if(!I.isObject(a.data))throw new Error("options.data is not a object!");return!0},P=function(a){if(I.isEmpty(a))throw new Error("sync options is empty object, cannot be synced!");if(!a.hasOwnProperty("url"))throw new Error("options.url was not specified!");if(I.isEmpty(a.url))throw new Error("options.url cannot be empty!");if(!a.hasOwnProperty("headers"))throw new Error("options.headers were not specified!");if(!I.isObject(a.headers))throw new Error("options.headers is not a objects!");return!0},Q=function(a){var b=l(a.url,!0),d={};if(I.isEmpty(b.params)||"MCS"===c.Module.getModuleName())if(b.tokens.length>0&&"MCS"!==c.Module.getModuleName()){var e=b.tokens[0].name;if("data"in a&&e in a.data){var f="data."+e;d[f]={$eq:a.data[e]}}}else if("data"in a&&"$loki"in a.data&&"number"==typeof a.data.$loki&&!isNaN(a.data.$loki)){var f="data.$loki";d[f]={$eq:a.data.$loki}}else"$loki"in a&&"number"==typeof a.$loki&&!isNaN(a.$loki)&&(d={$loki:{$eq:a.$loki}});else{var f="data."+b.params[0].name,g=b.tokens[0].pattern.indexOf("d")>=0?parseInt(b.params[0].value,10):b.params[0].value+"";d[f]={$eq:g}}return{dbquery:d,url:b.path,queryUrl:b}};t.prototype=Object.create(Error.prototype),t.prototype.constructor=t;var R=function(){var a=function(a,b,d,e){Array.isArray(E.$error)||(a.$error=[]),a.$error.length>c.maxSyncAttempts&&a.$error.shift(),a.$error.push({status:d||0,response:e||[],message:b||"Unknown error"}),a.$errorcounter=a.$error.length,g().update(a)},b=function(b,c){try{if(console.error(b,c),!b instanceof XMLHttpRequest)throw"SYNCID"in c&&e.dispatchEvent(400,"Bad Request",void 0,c.SYNCID),new Error("unknown XHR error during the sync process");"SYNCID"in c&&e.dispatchEvent(b.status,b.statusText,b,c.SYNCID);var d="response"in b?b.response:b.responseText||[];M.emit("error-sync",{status:b.status||0,response:d,message:b.statusText||"Unknown error"}),a(c,b.statusText,b.status,d)}catch(f){console.error(f)}finally{return!0}},d=function(a){if(!0===c.autoRemoveAfterReachMaxAttemps){new Promise(function(b){b(s(a))}).catch(function(a){b(a.message,0,"")})}},f=function(a,b){var c={status:b.status,statusText:b.statusText,response:"response"in b?b.response:b.responseText,headers:b.getAllResponseHeaders(),syncObj:a};return M.emit("post-sync",c),"SYNCID"in a&&e.dispatchEvent(c.status,c.statusText,b,a.SYNCID),c};return{run:function(a){return new Promise(function(e){if(0===c.maxSyncAttempts||(a.$errorcounter||0)<=c.maxSyncAttempts){console.log("syncProcess.process",a),M.emit("pre-sync",a);var g=w(a,!0);u(g.method,g.url,g.headers,g.data,g.responseType,c.syncTimeOut).then(f.bind(this,a)).then(function(b){return s(a),b}).then(c.Module.postSuccessOperations.bind(c.Module)).catch(function(c){return b(c,a)}).then(function(){e(!0)})}else d(a),e(!0)})}}}(),S=function(a){var b=[],d=0,e=!1,f=c.syncTimeOut,h=!1,i=!1,j=function(b){return new Promise(function(c,d){try{a.run(b).then(function(){c(!0)}).catch(function(a){d(a)})}catch(e){console.error(e),d(e)}})},l=function(){if(!e){var a=k();if(-1==a)return console.warn("sync db lock not released, restart the sync process!"),void l();if(0==a)return void l();var c=d++,f=b[d];if(!(E=b[c]))return void o();j(E).then(function(){n(f,E)&&setTimeout(function(){l()},1)}).catch(function(a){console.log("unknown sync process error",a),o()})}},m=function(a){if(!c.off&&(a||"boolean"==typeof a||(a=!1),!1!==c.autoSync||!1!==a))return c.isOnline()?h?void(i=!0):void setTimeout(function(){h=!0,e=!1,y(),b=g().find();try{l()}catch(a){console.log(a),o()}},s(a)):void o()},n=function(a,b){return!!a||(o(),M.emit("end-sync",b),!1)},o=function(){E={},q(),setTimeout(function(){m()},s())},p=function(){z(),e=!0,h=!1},q=function(){p(),h=!1,d=0,b.length=0},r=function(){return{current:d,obj:b[d],size:b.length,isRunning:h}},s=function(a){return a?1:i?(h=!1,i=!1,1):H?(H=!1,1):f};return{run:m,stop:p,status:r,reset:q}}(R);return{getDB:function(){return L},getHistory:function(a){return new Promise(function(b){b(g(a))})},get:function(a){return new Promise(function(b,c){h(),
B(b,c,new Promise(function(b){b(m(a))}))})},post:function(a){return new Promise(function(b,c){h(),B(b,c,new Promise(function(b){b(n(a))}))})},put:function(a){return new Promise(function(b,c){h(),B(b,c,new Promise(function(b){b(o(a))}))})},patch:function(a){return new Promise(function(b,c){h(),B(b,c,new Promise(function(b){b(q(a))}))})},delete:function(a){return new Promise(function(b,c){h(),B(b,c,new Promise(function(b){b(r(a))}))})},router:function(a){var b=this,c=function(a){if(I.isEmpty(a))throw console.error("sync router request was not provided!",a),new Error("sync router request was not provided!");if(!a.hasOwnProperty("method")&&!I.isEmpty(a.method))throw console.error("sync router method was not provided!",a),new Error("sync router method was not provided!");var c=I.clone(a);if(c.method=d.normalizeMethod(c.method),!b[c.method])throw console.error("specified router is not implemented!"),new Error("specified router is not implemented!");return new Promise(function(a){a(b[c.method](c))})};return new Promise(function(b,d){new Promise(function(b){b(c(a))}).then(function(a){b(a)}).catch(function(a){d(a)})})},operations:S,removeSync:function(a){return new Promise(function(a){a(s(_options))})},flush:x,events:M,isSyncRunning:A}}function x(a,b,c){var d="Request-ID";return{run:function(b){a.oneOn(),b()},runWithoutReadInBackground:function(b){a.dbFirstFalseForNextCall(),b()},listener:function(a,b){void 0!==c&&a&&c.addListener(a,function(a){b(a.detail)},!1)},registerRequestCompletedCallback:function(a,e){void 0!==c&&null!==a&&(b.isNumber(a)?c.addListener(a,function(a){e(a.detail.data,a.detail.status,a.detail.statusText,a.detail.requestid,a.detail.time)},!1):b.isObject(a)&&(a.hasOwnProperty(d)?c.addListener(a[d],function(a){e(a.detail.data,a.detail.status,a.detail.statusText,a.detail.requestid,a.detail.time)},!1):"function"==typeof a.getResponseHeader&&null!=a.getResponseHeader(d)&&c.addListener(a.getResponseHeader(d),function(a){e(a.detail.data,a.detail.status,a.detail.statusText,a.detail.requestid,a.detail.time)},!1)))}}}function y(a,b,c,d,e,f,g){function h(){var a=new i;this.isDbFirst=d.isDbFirst(),this._req={url:"",headers:{"Content-Type":"application/json; charset=utf-8"},data:void 0,method:"",username:"",password:""};var b=this;return Object.defineProperty(b,"xhr",{get:function(){return a}}),this._setResponseHeaders=function(a){this.responseHeaders={};for(var b in a)a.hasOwnProperty(b)&&(this.responseHeaders[b]=a[b]);this.forceMimeType&&(this.responseHeaders["Content-Type"]=this.forceMimeType),this.readyState=this.HEADERS_RECEIVED},["upload"].forEach(function(a){Object.defineProperty(b,a,{get:function(){return this.xhr[a]}})}),["abort"].forEach(function(a){Object.defineProperty(b,a,{value:function(){return this.xhr[a].apply(this.xhr,arguments)}})}),["ontimeout, timeout","withCredentials","onprogress"].forEach(function(a){Object.defineProperty(b,a,{get:function(){return this.xhr[a]},set:function(b){this.xhr[a]=b}})}),["onabort","onloadstart","onloadend","DONE","UNSENT","HEADERS_RECEIVED","LOADING","OPENED"].forEach(function(a){Object.defineProperty(b,a,{get:function(){return this.xhr[a]},set:function(b){this.xhr[a]=b}})}),Object.defineProperty(b,"onerror",{get:function(){return this.xhr.onerror},set:function(a){if(!1!==this.persistentPath){var c=this.xhr,d=this;b.originalonerror=a,c.onerror=function(){b.synconerror(),a.call(d)}}else this.xhr.onerror=a}}),Object.defineProperty(b,"onload",{get:function(){return this.xhr.onload},set:function(a){if(!1!==this.persistentPath){var c=this.xhr,d=this;b.originalonload=a,c.onload=function(){b.onreadystatechangefunction(),a.call(d)}}else this.xhr.onload=a}}),Object.defineProperty(b,"onreadystatechange",{get:function(){return this.xhr.onreadystatechange},set:function(a){if(!1!==this.persistentPath){var c=this.xhr,d=this;b.originalonreadystate=a,c.onreadystatechange=function(){4===c.readyState?b.onreadystatechangefunction():(d.readyState=c.readyState,d.response=c.response,d.responseText=c.responseText,d.responseXML=c.responseXML,d.status=c.status,d.statusText=c.statusText,d.responseType=c.responseType),a.call(d)}}else{var c=this.xhr;c.onreadystatechange=function(){a.call(c)}}}}),this.addEventListener=function(a,b){if(!1!==this.persistentPath){var c=this;"load"===a?c.onload=b:"error"===a?c.onerror=b:this.xhr.addEventListener(a,b)}else this.xhr.addEventListener.apply(this.xhr,arguments)},h.prototype.overrideMimeType=function(a){!1!==this.persistentPath?(this._req.headers||(this._req.headers={}),"string"==typeof a&&(this.forceMimeType=a.toLowerCase(),this._req.headers["Content-Type"]=this.forceMimeType),this.xhr.overrideMimeType(a)):this.xhr.overrideMimeType.apply(this.xhr,arguments)},h.prototype.setRequestHeader=function(a,b){if(!1!==this.persistentPath){if(k[a]||/^(Sec-|Proxy-)/.test(a))throw new Error('Refused to set unsafe header "'+a+'"');this.xhr.setRequestHeader(a,b),this._req.headers||(this._req.headers={}),this._req.headers[a]=b}else this.xhr.setRequestHeader.apply(this.xhr,arguments)},h.prototype.synconerror=function(){var a=this;a.readyState=this.xhr.readyState,a.responseText=this.xhr.responseText,a.responseType=this.xhr.responseType,a.response=this.xhr.response,a.responseXML=this.xhr.responseXML,a.status=this.xhr.status,a.statusText=this.xhr.statusText},h.prototype.onreadystatechangefunction=function(){var a=this,b=c.parseResponseHeaders(this.xhr.getAllResponseHeaders());a._setResponseHeaders(b),a.readyState=a.DONE,a.status=this.xhr.status,a.statusText=this.xhr.statusText,this.responseText=this.xhr.responseText,this.response=this.xhr.response,this.responseXML=this.xhr.responseXML},this.uniqueID=function(){return this.uniqueIDMemo||(uuid?this.uniqueIDMemo=uuid.v4():this.uniqueIDMemo=e.getUID()),this.uniqueIDMemo},this.open=function(a,b,c,e,f){return console.log(b),this.persistentPath=d.isPersistentUrl(b),!1===this.persistentPath?(console.debug("defake XHR"),this.defake(),this.xhr.open(a,b,!0,e,f)):(console.debug("PROXY"),this.proxyXHR(),this._req.method=a,this._req.url=b,this._req.username=e,this._req.password=f,this.xhr.open.apply(this.xhr,arguments))},this}var i=a,j={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"},k={"Accept-Charset":!0,"Accept-Encoding":!0,Connection:!0,"Content-Length":!0,Cookie:!0,Cookie2:!0,"Content-Transfer-Encoding":!0,Date:!0,Expect:!0,Host:!0,"Keep-Alive":!0,Referer:!0,TE:!0,Trailer:!0,"Transfer-Encoding":!0,Upgrade:!0,"User-Agent":!0,Via:!0};h.prototype.proxyXHR=function(){h.prototype.getAllResponseHeaders=function(){var a=this;if(a.readyState<a.HEADERS_RECEIVED)return"";var b="";for(var c in this.responseHeaders)this.responseHeaders.hasOwnProperty(c)&&!/^Set-Cookie2?$/i.test(c)&&(b+=c+": "+this.responseHeaders[c]+"\r\n");return b},h.prototype.getResponseHeader=function(a){var b=this;if(b.readyState<b.HEADERS_RECEIVED)return null;if(/^Set-Cookie2?$/i.test(a))return null;a=a.toLowerCase();for(var c in this.responseHeaders)if(c.toLowerCase()==a)return this.responseHeaders[c];return null},h.prototype.send=function(a){function h(){if(!e.isEmpty(a)&&e.isObject(a))if(a.hasOwnProperty("meta")&&a.meta.hasOwnProperty("offline-persist")){if("GET"===l._req.method)return!1}else a.hasOwnProperty("$loki")&&delete a.$loki,a.hasOwnProperty("meta")&&delete a.meta;return!0}function i(){var a=l.uniqueID()+"-SYNC-"+Math.floor(1e3*Math.random());l._req.SYNCID=a,b.router(l._req).then(function(){f.addListener(a,function(a){k(a.detail.data)},!1),b.operations.run(!0)}).catch(function(a){console.error(a),r(400,p,a)})}function k(a){var b=d.Module,f="response"in a?a.response:a.responseText;if(4===a.readyState){e.isEmpty(f)&&(f="");var h=c.parseResponseHeaders(a.getAllResponseHeaders());if(h["Request-ID"]=l.uniqueID(),a.status>=200&&a.status<300){g.$emit("success",{data:f,status:a.status,headers:a.getAllResponseHeaders(),requestID:l.uniqueID()});var i=a.getResponseHeader("Content-Type");if(null===i){if("DELETE"!==l._req.method)throw new Error("XHR did not return any HTTP headers!")}else if(null==(i=i&&i.split(";",1)[0])||"application/json"!==i){if("DELETE"!==l._req.method)throw new Error("persistence library could handle only JSON responses!")}else"String"==typeof f&&(f=JSON.parse(f));l._req.headers=h,q("noCache",!1)&&c.isSupportedHTTPMethod(b,l._req.method)?(l._req.data=f,"POST"!==l._req.method&&"PUT"!==l._req.method&&"PATCH"!==l._req.method||void 0!==l._req.data.meta&&l._req.data.meta.hasOwnProperty("offline-persist")&&delete l._req.data.meta["offline-persist"],b.router(l._req).then(function(){r(a.status,h,f)}).catch(function(a){console.error(a),r(400,h,a)})):r(a.status,h,f)}else a.status>=300&&304!=a.status?(g.$emit("error",{event:event}),l._req.headers=h,q("noCache",!1)&&c.isSupportedHTTPMethod(b,l._req.method)?("GET"===l._req.method&&(l._req.data=[]),b.router(l._req).then(function(b){b?r(a.status,h,b):r(a.status,h,f)}).catch(function(a){r(400,h,"Error while executing operation against the offline database: "+a,f)})):r(a.status,h,f)):r(a.status,h,f)}else r(a.status,p,f)}var l=this;l.responseType&&(this._req.responseType=l.responseType);try{a&&(this._req.data="string"==typeof a?JSON.parse(a):JSON.parse(JSON.stringify(a)))}catch(t){throw new Error("persistence library could execute only JSON payload!")}var m=d.isOnline(),n=function(){setTimeout(function(){console.debug("Sync XHR in OFF-LINE MODE"),s(l._req,!0)},1)},o=function(){setTimeout(function(){console.debug("Sync XHR in ON-LINE MODE"),(q("fetchPolicy","FETCH_FROM_CACHE_SCHEDULE_REFRESH")||l.isDbFirst)&&s(l._req,!1),h()&&i()},1)};m?o():n();var p={"Content-Type":"application/json; charset=utf-8","Request-ID":l.uniqueID()},q=function(a,b){return l.persistentPath.isPolicy(a,b)},r=function(a,b,c){q("fetchPolicy","FETCH_FROM_CACHE_SCHEDULE_REFRESH")||l.isDbFirst?f.dispatchEvent(a,j[a],c,l.uniqueID()):l.respond2(a,b,c)},s=function(a,f){var g=d.Module;if("GET"===a.method&&delete a.data,q("noCache",!1)&&c.isSupportedHTTPMethod(g,a.method))return g.router(a).then(function(c){return a.hasOwnProperty("method")&&"GET"!==a.method&&!0===f&&(l._req.data=c,b.router(l._req)),c}).then(function(a){e.isEmpty(a)?l.respond2(404,p,"Offline Not Found"):l.respond2(200,p,a)}).catch(function(a){console.error(a),l.respond2(400,p,a)});a.hasOwnProperty("method")&&c.isSupportedHTTPMethod(b,a.method)?"GET"!==a.method&&!0===f?(l._req.data=a.data,b.router(a).then(function(a){l.respond2(200,p,null)}).catch(function(a){l.respond2(400,p,null)})):l.respond2(0,p,null):l.respond2(400,p,null)}},h.prototype.respond2=function(a,b,c){var d=this;if(d._setResponseHeaders(b),d.readyState=d.DONE,d.status=a,d.statusText=j[a],null!=c?"string"==typeof c?d.responseText=c:"object"==typeof c?d.responseType&&"json"==d.responseType?d.response=c:d.responseText=JSON.stringify(c):(d.responseText=null,d.response=d.responseText):(d.responseText=null,d.response=d.responseText),0!=a)if(d.originalonload)d.originalonload.call(this);else{if(!d.originalonreadystate)throw new Error("no response XHR method was implemented!");d.originalonreadystate.call(this)}else if(d.originalonerror)d.originalonerror.call(this);else if(d.originalonload)d.originalonload.call(this);else{if(!d.originalonreadystate)throw new Error("no response XHR method was implemented!");d.originalonreadystate.call(this)}}},h.prototype.defake=function(){var a=this;return["send","removeEventListener","getResponseHeader","getAllResponseHeaders","dispatchEvent"].forEach(function(b){Object.defineProperty(a,b,{value:function(){return this.xhr[b].apply(this.xhr,arguments)}})}),["readyState","responseText","response","responseType","responseXML","status","statusText"].forEach(function(b){Object.defineProperty(a,b,{get:function(){return this.xhr[b]},set:function(a){this.xhr[b]=a}})}),this},XMLHttpRequest=function(b){if("boolean"==typeof b){if(!0===b)return new h;if(!1===b)return new a}return!d.isOn()||d.off?new a:new h},XMLHttpRequest.originalXMLHttpRequest=i}function z(){if(!XMLHttpRequest.originalXMLHttpRequest)throw"Sync Express not installed.";XMLHttpRequest=XMLHttpRequest.originalXMLHttpRequest}function A(){function a(a){return g.module.flush(a).then(i.flush.bind(i))}function b(){y(XMLHttpRequest,i,h,g,d,e,f)}function c(){z()}var d=m(),e=t(),f=u(),g=o(d),h=n(d,g),i=w(f,d,g,h,e);g.module=new q(g,d,h);var j=x(g,d,e);y(XMLHttpRequest,i,h,g,d,e,f);var k={};return k.options=g,k.MCSHandler=function(){return new q(g,d,h)},k.RequestHandler=function(){return new r(g,d,h)},k.OracleRestHandler=function(){return new s(g,d,h)},k.process=j,k._flush=a,k._install=b,k._uninstall=c,k}var B,C,D="18.1.3.0";"function"==typeof define&&define.amd?(B=define,define=void 0):"object"==typeof exports&&(C=exports,exports=void 0),function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.loki=b()}(this,function(){return function(){"use strict";function a(a,b,c){var d,e;if(!a||!b||!0===a||!0===b){if(!(!0!==a&&!1!==a||!0!==b&&!1!==b))return c?a===b:!a&&b;if(void 0===b||null===b||!0===a||!1===b)return c;if(void 0===a||null===a||!1===a||!0===b)return!0}return a===b?c:a<b||!(a>b)&&(d=a.toString(),e=b.toString(),d==e?c:d<e)}function b(a,b,c){var d,e;if(!a||!b||!0===a||!0===b){if(!(!0!==a&&!1!==a||!0!==b&&!1!==b))return c?a===b:!!a&&!b;if(void 0===a||null===a||!1===a||!0===b)return c;if(void 0===b||null===b||!0===a||!1===b)return!0}return a===b?c:a>b||!(a<b)&&(d=a.toString(),e=b.toString(),d==e?c:d>e)}function c(c,d,e){return c===d?0:a(c,d,!1)?e?1:-1:b(c,d,!1)?e?-1:1:0}function d(a,b,d){for(var e,f,g=0,h=0,i=a.length;h<i;h++)if(e=a[h],f=e[0],0!==(g=c(b[f],d[f],e[1])))return g;return 0}function e(a,b,c,d){var f=b[0];if(void 0===a||null===a||!a.hasOwnProperty(f))return!1;var g=!1,h=a[f];if(Array.isArray(h)){var i;for(i in h)if(!0===(g=g||e(h[i],b.slice(1,b.length),c,d)))break}else g="object"==typeof h?e(h,b.slice(1,b.length),c,d):c(h,d);return g}function f(a){return"string"==typeof a||Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:"object"==typeof a&&null!==a?function(b){return E.call(a,b)}:null}function g(a,b){for(var c in b)if(E.call(b,c))return G[c](a,b[c]);return!1}function h(a,b){var c,d=b||"parse-stringify";switch(d){case"parse-stringify":c=JSON.parse(JSON.stringify(a));break;case"jquery-extend-deep":c=jQuery.extend(!0,{},a);break;case"shallow":c=Object.create(a.prototype||null),Object.keys(a).map(function(b){c[b]=a[b]})}return c}function i(a,b){var c,d=[];if("parse-stringify"==b)return h(a,b);for(c=a.length-1;c<=0;c--)d.push(h(a[c],b));return d}function j(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(a){return!1}}function k(){}function l(a,b){this.filename=a||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.verbose=!(!b||!b.hasOwnProperty("verbose"))&&b.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var c=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};b&&b.hasOwnProperty("env")?this.ENV=b.env:this.ENV=c(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(b,!0),this.on("init",this.clearChanges)}function m(){this.fs=require("fs")}function n(){}function o(a,b){return b=b||{},b.queryObj=b.queryObj||null,b.queryFunc=b.queryFunc||null,b.firstOnly=b.firstOnly||!1,this.collection=a,this.searchIsChained=!b.queryObj&&!b.queryFunc,this.filteredrows=[],this.filterInitialized=!1,void 0!==b.queryObj&&null!==b.queryObj?this.find(b.queryObj,b.firstOnly):void 0!==b.queryFunc&&null!==b.queryFunc?this.where(b.queryFunc):this}function p(a,b,c){this.collection=a,this.name=b,this.rebuildPending=!1,this.options=c||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new o(a),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function q(a,b){function c(a){var b="function"==typeof Set?new Set:[];b.add||(b.add=function(a){return-1===this.indexOf(a)&&this.push(a),this}),a.forEach(function(a){b.add(a.object)}),b.forEach(function(a){if(!E.call(a,"$loki"))return m.removeAutoUpdateObserver(a);try{m.update(a)}catch(b){}})}function d(a,b,c){m.changes.push({name:a,operation:b,obj:JSON.parse(JSON.stringify(c))})}function e(){m.changes=[]}function f(a){a&&(a.meta||(a.meta={}),a.meta.created=(new Date).getTime(),a.meta.revision=0)}function g(a){a&&(a.meta.updated=(new Date).getTime(),a.meta.revision+=1)}function h(a){d(m.name,"I",a)}function i(a){d(m.name,"U",a)}function j(a){f(a),h(a)}function k(a){g(a),i(a)}function l(){p=m.disableChangesApi?f:j,q=m.disableChangesApi?g:k}this.name=a,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=a,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var m=this;b=b||{},b.hasOwnProperty("unique")&&(Array.isArray(b.unique)||(b.unique=[b.unique]),b.unique.forEach(function(a){m.uniqueNames.push(a),m.constraints.unique[a]=new B(a)})),b.hasOwnProperty("exact")&&b.exact.forEach(function(a){m.constraints.exact[a]=new C(a)}),this.transactional=!!b.hasOwnProperty("transactional")&&b.transactional,this.cloneObjects=!!b.hasOwnProperty("clone")&&b.clone,this.cloneMethod=b.hasOwnProperty("cloneMethod")?b.cloneMethod:"parse-stringify",this.asyncListeners=!!b.hasOwnProperty("asyncListeners")&&b.asyncListeners,this.disableChangesApi=!b.hasOwnProperty("disableChangesApi")||b.disableChangesApi,this.autoupdate=!!b.hasOwnProperty("autoupdate")&&b.autoupdate,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(b.ttl||-1,b.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.ensureId();var n=[];if(b&&b.indices)if("[object Array]"===Object.prototype.toString.call(b.indices))n=b.indices;else{if("string"!=typeof b.indices)throw new TypeError("Indices needs to be a string or an array of strings");n=[b.indices]}for(var o=0;o<n.length;o++)this.ensureIndex(n[o]);this.observerCallback=c,this.getChanges=function(){return m.changes},this.flushChanges=e;var p,q;l(),this.setChangesApi=function(a){m.disableChangesApi=!a,l()},this.on("insert",function(a){p(a)}),this.on("update",function(a){q(a)}),this.on("delete",function(a){m.disableChangesApi||d(m.name,"R",a)}),this.on("warning",function(a){m.console.warn(a)}),e()}function r(a){return-1!==a.indexOf(".")}function s(a){return parseFloat(a,10)}function t(a,b){return a+b}function u(a,b){return a-b}function v(a){return a.reduce(t,0)/a.length}function w(a){var b=v(a),c=a.map(function(a){var c=a-b;return c*c}),d=v(c);return Math.sqrt(d)}function x(a,b,c){if(!1===c)return a[b];for(var d=b.split("."),e=a;d.length>0;)e=e[d.shift()];return e}function y(a,b,c){for(var d,e,f=0,g=a.length;f<g;){if(e=f+g>>1,0===(d=c.apply(null,[b,a[e]])))return{found:!0,index:e};d<0?g=e:f=e+1}return{found:!1,index:g}}function z(a){return function(b,c){return y(b,c,a)}}function A(){}function B(a){this.field=a,this.keyMap={},this.lokiMap={}}function C(a){this.index={},this.field=a}function D(a){this.field=a}var E=Object.prototype.hasOwnProperty,F={copyProperties:function(a,b){var c;for(c in a)b[c]=a[c]},resolveTransformObject:function(a,b,c){var d,e;if("number"!=typeof c&&(c=0),++c>=10)return a;for(d in a)"string"==typeof a[d]&&0===a[d].indexOf("[%lktxp]")?(e=a[d].substring(8),b.hasOwnProperty(e)&&(a[d]=b[e])):"object"==typeof a[d]&&(a[d]=F.resolveTransformObject(a[d],b,c));return a},resolveTransformParams:function(a,b){var c,d,e=[];if(void 0===b)return a;for(c=0;c<a.length;c++)d=JSON.parse(JSON.stringify(a[c])),e.push(F.resolveTransformObject(d,b));return e}},G={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){return b!==b?a===a:a!==b},$dteq:function(c,d){return!a(c,d,!1)&&!b(c,d,!1)},$gt:function(a,c){return b(a,c,!1)},$gte:function(a,c){return b(a,c,!0)},$lt:function(b,c){return a(b,c,!1)},$lte:function(b,c){return a(b,c,!0)},$in:function(a,b){return-1!==b.indexOf(a)},$nin:function(a,b){return-1===b.indexOf(a)},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return void 0!==b[a]},$undefinedin:function(a,b){return void 0===b[a]},$regex:function(a,b){return b.test(a)},$containsString:function(a,b){return"string"==typeof a&&-1!==a.indexOf(b)},$containsNone:function(a,b){return!G.$containsAny(a,b)},$containsAny:function(a,b){var c=f(a);return null!==c&&(Array.isArray(b)?b.some(c):c(b))},$contains:function(a,b){var c=f(a);return null!==c&&(Array.isArray(b)?b.every(c):c(b))},$type:function(a,b){var c=typeof a;return"object"===c&&(Array.isArray(a)?c="array":a instanceof Date&&(c="date")),"object"!=typeof b?c===b:g(c,b)},$size:function(a,b){return!!Array.isArray(a)&&("object"!=typeof b?a.length===b:g(a.length,b))},$len:function(a,b){return"string"==typeof a&&("object"!=typeof b?a.length===b:g(a.length,b))},$where:function(a,b){return!0===b(a)},$not:function(a,b){return!g(a,b)},$and:function(a,b){for(var c=0,d=b.length;c<d;c+=1)if(!g(a,b[c]))return!1;return!0},$or:function(a,b){for(var c=0,d=b.length;c<d;c+=1)if(g(a,b[c]))return!0;return!1}},H=["$eq","$aeq","$dteq","$gt","$gte","$lt","$lte"];return k.prototype.events={},k.prototype.asyncListeners=!1,k.prototype.on=function(a,b){var c=this.events[a];return c||(c=this.events[a]=[]),c.push(b),b},k.prototype.emit=function(a,b){var c=this;if(!a||!this.events[a])throw new Error("No event "+a+" defined");this.events[a].forEach(function(a){c.asyncListeners?setTimeout(function(){a(b)},1):a(b)})},k.prototype.removeListener=function(a,b){if(this.events[a]){var c=this.events[a];c.splice(c.indexOf(b),1)}},l.prototype=new k,l.prototype.getIndexedAdapter=function(){var a;return"function"==typeof require&&(a=require("./loki-indexed-adapter.js")),a},l.prototype.configureOptions=function(a,b){var c={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},d={fs:m,localStorage:n};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==a){if(this.options=a,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof d[a.persistenceMethod]&&(this.persistenceMethod=a.persistenceMethod,this.persistenceAdapter=new d[a.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=a.adapter,this.options.adapter=null),a.autoload&&b){var e=this;setTimeout(function(){e.loadDatabase(a,a.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(a,a.autosaveCallback):this.autosaveEnable())}null===this.persistenceAdapter&&(this.persistenceMethod=c[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new d[this.persistenceMethod]))},l.prototype.anonym=function(a,b){var c=new q("anonym",b);return c.insert(a),this.verbose&&(c.console=console),c},l.prototype.addCollection=function(a,b){var c=new q(a,b);return this.collections.push(c),this.verbose&&(c.console=console),c},l.prototype.loadCollection=function(a){if(!a.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(a)},l.prototype.getCollection=function(a){var b,c=this.collections.length;for(b=0;b<c;b+=1)if(this.collections[b].name===a)return this.collections[b];return this.emit("warning","collection "+a+" not found"),null},l.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});return b},l.prototype.removeCollection=function(a){var b,c=this.collections.length;for(b=0;b<c;b+=1)if(this.collections[b].name===a){var d=new q(a,{}),e=this.collections[b];for(var f in e)e.hasOwnProperty(f)&&d.hasOwnProperty(f)&&(e[f]=d[f]);return void this.collections.splice(b,1)}},l.prototype.getName=function(){return this.name},l.prototype.serializeReplacer=function(a,b){switch(a){case"autosaveHandle":case"persistenceAdapter":case"constraints":return null;default:return b}},l.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer)},l.prototype.toJson=l.prototype.serialize,l.prototype.loadJSON=function(a,b){var c;c=0===a.length?{}:JSON.parse(a),this.loadJSONObject(c,b)},l.prototype.loadJSONObject=function(a,b){var c,d,e,f,g=0,h=a.collections?a.collections.length:0;for(this.name=a.name,this.databaseVersion=1,a.hasOwnProperty("databaseVersion")&&(this.databaseVersion=a.databaseVersion),this.collections=[],g;g<h;g+=1){if(c=a.collections[g],d=this.addCollection(c.name),d.transactional=c.transactional,d.asyncListeners=c.asyncListeners,d.disableChangesApi=c.disableChangesApi,d.cloneObjects=c.cloneObjects,d.cloneMethod=c.cloneMethod||"parse-stringify",d.autoupdate=c.autoupdate,e=c.data.length,f=0,b&&b.hasOwnProperty(c.name)){var i=b[c.name].inflate?b[c.name].inflate:F.copyProperties;for(f;f<e;f++){var j=new b[c.name].proto;i(c.data[f],j),d.data[f]=j,d.addAutoUpdateObserver(j)}}else for(f;f<e;f++)d.data[f]=c.data[f],d.addAutoUpdateObserver(d.data[f]);if(d.maxId=0===c.data.length?0:c.maxId,d.idIndex=c.idIndex,void 0!==c.binaryIndices&&(d.binaryIndices=c.binaryIndices),void 0!==c.transforms&&(d.transforms=c.transforms),d.ensureId(),d.uniqueNames=[],c.hasOwnProperty("uniqueNames"))for(d.uniqueNames=c.uniqueNames,f=0;f<d.uniqueNames.length;f++)d.ensureUniqueIndex(d.uniqueNames[f]);if(void 0!==c.DynamicViews)for(var k=0;k<c.DynamicViews.length;k++){var l=c.DynamicViews[k],m=d.addDynamicView(l.name,l.options);m.resultdata=l.resultdata,m.resultsdirty=l.resultsdirty,m.filterPipeline=l.filterPipeline,m.sortCriteria=l.sortCriteria,m.sortFunction=null,m.sortDirty=l.sortDirty,m.resultset.filteredrows=l.resultset.filteredrows,m.resultset.searchIsChained=l.resultset.searchIsChained,m.resultset.filterInitialized=l.resultset.filterInitialized,m.rematerialize({removeWhereFilters:!0})}}},l.prototype.close=function(a){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(a),a=void 0)),a&&this.on("close",a),this.emit("close")},l.prototype.generateChangesNotification=function(a){function b(a){return a.name}var c=[],d=a||this.collections.map(b);return this.collections.forEach(function(a){-1!==d.indexOf(b(a))&&(c=c.concat(a.getChanges()))}),c},l.prototype.serializeChanges=function(a){return JSON.stringify(this.generateChangesNotification(a))},l.prototype.clearChanges=function(){this.collections.forEach(function(a){a.flushChanges&&a.flushChanges()})},m.prototype.loadDatabase=function(a,b){this.fs.readFile(a,{encoding:"utf8"},function(a,c){b(a?new Error(a):c)})},m.prototype.saveDatabase=function(a,b,c){this.fs.writeFile(a,b,c)},m.prototype.deleteDatabase=function(a,b){this.fs.unlink(a,function(a){a?b(new Error(a)):b()})},n.prototype.loadDatabase=function(a,b){b(j()?localStorage.getItem(a):new Error("localStorage is not available"))},n.prototype.saveDatabase=function(a,b,c){j()?(localStorage.setItem(a,b),c(null)):c(new Error("localStorage is not available"))},n.prototype.deleteDatabase=function(a,b){j()?(localStorage.removeItem(a),b(null)):b(new Error("localStorage is not available"))},l.prototype.loadDatabase=function(a,b){var c=b||function(a,b){if(a)throw a},d=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(b){if("string"==typeof b){var e=!1;try{d.loadJSON(b,a||{}),e=!0}catch(f){c(f)}e&&(c(null),d.emit("loaded","database "+d.filename+" loaded"))}else"object"!=typeof b||null===b||b instanceof Error?c(b):(d.loadJSONObject(b,a||{}),c(null),d.emit("loaded","database "+d.filename+" loaded"))}):c(new Error("persistenceAdapter not configured"))},l.prototype.saveDatabase=function(a){var b=a||function(a){if(a)throw a},c=this;null!==this.persistenceAdapter?"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this,function(a){c.autosaveClearFlags(),b(a)}):this.persistenceAdapter.saveDatabase(this.filename,c.serialize(),function(a){c.autosaveClearFlags(),b(a)}):b(new Error("persistenceAdapter not configured"))},l.prototype.save=l.prototype.saveDatabase,l.prototype.deleteDatabase=function(a,b){var c=b||function(a,b){if(a)throw a};null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,function(a){c(a)}):c(new Error("persistenceAdapter not configured"))},l.prototype.autosaveDirty=function(){for(var a=0;a<this.collections.length;a++)if(this.collections[a].dirty)return!0;return!1},l.prototype.autosaveClearFlags=function(){for(var a=0;a<this.collections.length;a++)this.collections[a].dirty=!1},l.prototype.autosaveEnable=function(a,b){this.autosave=!0;var c=5e3,d=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(c=this.autosaveInterval),this.autosaveHandle=setInterval(function(){d.autosaveDirty()&&d.saveDatabase(b)},c)},l.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},o.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},o.prototype.toJSON=function(){var a=this.copy();return a.collection=null,a},o.prototype.limit=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=new o(this.collection);return b.filteredrows=this.filteredrows.slice(0,a),b.filterInitialized=!0,b},o.prototype.offset=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=new o(this.collection);return b.filteredrows=this.filteredrows.slice(a),b.filterInitialized=!0,b},o.prototype.copy=function(){var a=new o(this.collection);return this.filteredrows.length>0&&(a.filteredrows=this.filteredrows.slice()),a.filterInitialized=this.filterInitialized,a},o.prototype.branch=o.prototype.copy,o.prototype.transform=function(a,b){var c,d,e=this;if("string"==typeof a&&this.collection.transforms.hasOwnProperty(a)&&(a=this.collection.transforms[a]),"object"!=typeof a||!Array.isArray(a))throw new Error("Invalid transform");for(void 0!==b&&(a=F.resolveTransformParams(a,b)),c=0;c<a.length;c++)switch(d=a[c],d.type){case"find":e.find(d.value);break;case"where":e.where(d.value);break;case"simplesort":
e.simplesort(d.property,d.desc);break;case"compoundsort":e.compoundsort(d.value);break;case"sort":e.sort(d.value);break;case"limit":e=e.limit(d.value);break;case"offset":e=e.offset(d.value);break;case"map":e=e.map(d.value);break;case"eqJoin":e=e.eqJoin(d.joinData,d.leftJoinKey,d.rightJoinKey,d.mapFun);break;case"mapReduce":e=e.mapReduce(d.mapFunction,d.reduceFunction);break;case"update":e.update(d.value);break;case"remove":e.remove()}return e},o.prototype.sort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var b=function(a,b){return function(c,d){return a(b[c],b[d])}}(a,this.collection.data);return this.filteredrows.sort(b),this},o.prototype.simplesort=function(a,b){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),void 0===b&&(b=!1);var d=function(a,b,d){return function(e,f){return c(d[e][a],d[f][a],b)}}(a,b,this.collection.data);return this.filteredrows.sort(d),this},o.prototype.compoundsort=function(a){if(0===a.length)throw new Error("Invalid call to compoundsort, need at least one property");var b;if(1===a.length)return b=a[0],Array.isArray(b)?this.simplesort(b[0],b[1]):this.simplesort(b,!1);for(var c=0,e=a.length;c<e;c+=1)b=a[c],Array.isArray(b)||(a[c]=[b,!1]);this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());var f=function(a,b){return function(c,e){return d(a,b[c],b[e])}}(a,this.collection.data);return this.filteredrows.sort(f),this},o.prototype.calculateRange=function(c,d,e){var f=this.collection.data,g=this.collection.binaryIndices[d].values,h=0,i=g.length-1,j=0;if(0===f.length)return[0,-1];var k=f[g[h]][d],l=f[g[i]][d];switch(c){case"$eq":case"$aeq":case"$dteq":if(a(e,k,!1)||b(e,l,!1))return[0,-1];break;case"$gt":if(b(e,l,!0))return[0,-1];break;case"$gte":if(b(e,l,!1))return[0,-1];break;case"$lt":if(a(e,k,!0))return[0,-1];if(a(l,e,!1))return[0,f.length-1];break;case"$lte":if(a(e,k,!1))return[0,-1];if(a(l,e,!0))return[0,f.length-1]}for(;h<i;)j=h+i>>1,a(f[g[j]][d],e,!1)?h=j+1:i=j;var m=h;for(i=g.length-1;h<i;)j=h+i>>1,a(e,f[g[j]][d],!1)?i=j:h=j+1;var n=i,o=f[g[m]][d],p=f[g[n]][d];switch(c){case"$eq":return o!==e?[0,-1]:(p!==e&&n--,[m,n]);case"$dteq":return o>e||o<e?[0,-1]:((p>e||p<e)&&n--,[m,n]);case"$gt":return a(p,e,!0)?[0,-1]:[n,f.length-1];case"$gte":return a(o,e,!1)?[0,-1]:[m,f.length-1];case"$lt":return 0===m&&a(o,e,!1)?[0,0]:[0,m-1];case"$lte":return p!==e&&n--,0===n&&a(p,e,!1)?[0,0]:[0,n];default:return[0,f.length-1]}},o.prototype.findOr=function(a){for(var b=null,c=0,d=0,e=[],f=[],g=0,h=this.count(),i=0,j=a.length;i<j;i++){if(b=this.branch().find(a[i]).filteredrows,(d=b.length)===h)return this;for(c=0;c<d;c++)g=b[c],void 0===f[g]&&(f[g]=!0,e.push(g))}return this.filteredrows=e,this.filterInitialized=!0,this},o.prototype.$or=o.prototype.findOr,o.prototype.findAnd=function(a){for(var b=0,c=a.length;b<c;b++){if(0===this.count())return this;this.find(a[b])}return this},o.prototype.$and=o.prototype.findAnd,o.prototype.find=function(a,b){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var c,d,f,g,h,i,j=a||"getAll",k=!1,l=[],m=null;if(b=b||!1,"object"==typeof j)for(c in j)if(E.call(j,c)){d=c,f=j[c];break}if(!d||"getAll"===j)return this.searchIsChained?this:this.collection.data.slice();if("$and"===d||"$or"===d)return this.searchIsChained?(this[d](f),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(l=this.collection.chain()[d](f).data(),b?0===l.length?[]:l[0]:l);if(null===f||"object"!=typeof f||f instanceof Date)g="$eq",h=f;else{if("object"!=typeof f)throw new Error("Do not know what you want to do.");for(i in f)if(E.call(f,i)){g=i,h=f[i];break}}"$regex"===g&&(Array.isArray(h)?h=new RegExp(h[0],h[1]):h instanceof RegExp||(h=new RegExp(h)));var n=-1!==d.indexOf(".");!(n||this.searchIsChained&&this.filterInitialized)&&this.collection.binaryIndices[d]&&-1!==H.indexOf(g)&&(this.collection.ensureIndex(d),k=!0,m=this.collection.binaryIndices[d]);var o=G[g],p=this.collection.data,q=0;if(!this.searchIsChained){if(k){var r=this.calculateRange(g,d,h);if(b)return-1!==r[1]?p[m.values[r[0]]]:[];for(q=r[0];q<=r[1];q++)l.push(p[m.values[q]])}else{if(q=p.length,b){if(n){for(d=d.split(".");q--;)if(e(p[q],d,o,h))return p[q]}else for(;q--;)if(o(p[q][d],h))return p[q];return[]}if(n)for(d=d.split(".");q--;)e(p[q],d,o,h)&&l.push(p[q]);else for(;q--;)o(p[q][d],h)&&l.push(p[q])}return l}var s,t=0;if(this.filterInitialized)if(s=this.filteredrows,q=s.length,n)for(d=d.split(".");q--;)t=s[q],e(p[t],d,o,h)&&l.push(t);else for(;q--;)t=s[q],o(p[t][d],h)&&l.push(t);else{if(k){var u=this.calculateRange(g,d,h);for(q=u[0];q<=u[1];q++)l.push(m.values[q])}else if(q=p.length,n)for(d=d.split(".");q--;)e(p[q],d,o,h)&&l.push(q);else for(;q--;)o(p[q][d],h)&&l.push(q);this.filterInitialized=!0}return this.filteredrows=l,this},o.prototype.where=function(a){var b,c=[];if("function"!=typeof a)throw new TypeError("Argument is not a stored view or a function");b=a;try{if(this.searchIsChained){if(this.filterInitialized){for(var d=this.filteredrows.length;d--;)!0===b(this.collection.data[this.filteredrows[d]])&&c.push(this.filteredrows[d]);return this.filteredrows=c,this}for(var e=this.collection.data.length;e--;)!0===b(this.collection.data[e])&&c.push(e);return this.filteredrows=c,this.filterInitialized=!0,this}for(var f=this.collection.data.length;f--;)!0===b(this.collection.data[f])&&c.push(this.collection.data[f]);return c}catch(g){throw g}},o.prototype.count=function(){return this.searchIsChained&&this.filterInitialized?this.filteredrows.length:this.collection.count()},o.prototype.data=function(a){var b,c,d,e=[],f=this.collection.data;if(a=a||{},this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||a.forceClones){for(b=f.length,d=a.forceCloneMethod||this.collection.cloneMethod,c=0;c<b;c++)e.push(h(f[c],d));return e}return f.slice()}this.filterInitialized=!0}var g=this.filteredrows;if(b=g.length,this.collection.cloneObjects||a.forceClones)for(d=a.forceCloneMethod||this.collection.cloneMethod,c=0;c<b;c++)e.push(h(f[g[c]],d));else for(c=0;c<b;c++)e.push(f[g[c]]);return e},o.prototype.update=function(a){if("function"!=typeof a)throw new TypeError("Argument is not a function");this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex());for(var b=this.filteredrows.length,c=this.collection.data,d=0;d<b;d++)a(c[this.filteredrows[d]]),this.collection.update(c[this.filteredrows[d]]);return this},o.prototype.remove=function(){return this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.remove(this.data()),this.filteredrows=[],this},o.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},o.prototype.eqJoin=function(a,b,c,d){var e,f,g,h=[],i=[],j=[],k="function"==typeof b,l="function"==typeof c,m={};if(h=this.data(),e=h.length,a instanceof o)i=a.data();else{if(!Array.isArray(a))throw new TypeError("joinData needs to be an array or result set");i=a}f=i.length;for(var n=0;n<f;n++)g=l?c(i[n]):i[n][c],m[g]=i[n];d||(d=function(a,b){return{left:a,right:b}});for(var p=0;p<e;p++)g=k?b(h[p]):h[p][b],j.push(d(h[p],m[g]||{}));return this.collection=new q("joinData"),this.collection.insert(j),this.filteredrows=[],this.filterInitialized=!1,this},o.prototype.map=function(a){var b=this.data().map(a);return this.collection=new q("mappedData"),this.collection.insert(b),this.filteredrows=[],this.filterInitialized=!1,this},p.prototype=new k,p.prototype.rematerialize=function(a){var b,c,d;if(a=a||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new o(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),a.hasOwnProperty("removeWhereFilters"))for(b=this.filterPipeline.length,c=b;c--;)"where"===this.filterPipeline[c].type&&(c!==this.filterPipeline.length-1&&(this.filterPipeline[c]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var e=this.filterPipeline;for(this.filterPipeline=[],b=e.length,d=0;d<b;d++)this.applyFind(e[d].val);return this.data(),this.emit("rebuild",this),this},p.prototype.branchResultset=function(a,b){var c=this.resultset.branch();return void 0===a?c:c.transform(a,b)},p.prototype.toJSON=function(){var a=new p(this.collection,this.name,this.options);return a.resultset=this.resultset,a.resultdata=[],a.resultsdirty=!0,a.filterPipeline=this.filterPipeline,a.sortFunction=this.sortFunction,a.sortCriteria=this.sortCriteria,a.sortDirty=this.sortDirty,a.collection=null,a},p.prototype.removeFilters=function(){this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1},p.prototype.applySort=function(a){return this.sortFunction=a,this.sortCriteria=null,this.queueSortPhase(),this},p.prototype.applySimpleSort=function(a,b){return this.sortCriteria=[[a,b||!1]],this.sortFunction=null,this.queueSortPhase(),this},p.prototype.applySortCriteria=function(a){return this.sortCriteria=a,this.sortFunction=null,this.queueSortPhase(),this},p.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},p.prototype.commit=function(){return this.cachedresultset=null,this},p.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},p.prototype._indexOfFilterWithId=function(a){if("string"==typeof a||"number"==typeof a)for(var b=0,c=this.filterPipeline.length;b<c;b+=1)if(a===this.filterPipeline[b].uid)return b;return-1},p.prototype._addFilter=function(a){this.filterPipeline.push(a),this.resultset[a.type](a.val)},p.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var a=this.filterPipeline;this.filterPipeline=[];for(var b=0,c=a.length;b<c;b+=1)this._addFilter(a[b]);return this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this},p.prototype.applyFilter=function(a){var b=this._indexOfFilterWithId(a.uid);return b>=0?(this.filterPipeline[b]=a,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(a),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),this)},p.prototype.applyFind=function(a,b){return this.applyFilter({type:"find",val:a,uid:b}),this},p.prototype.applyWhere=function(a,b){return this.applyFilter({type:"where",val:a,uid:b}),this},p.prototype.removeFilter=function(a){var b=this._indexOfFilterWithId(a);if(b<0)throw new Error("Dynamic view does not contain a filter with ID: "+a);return this.filterPipeline.splice(b,1),this.reapplyFilters(),this},p.prototype.count=function(){return this.options.persistent?this.resultdata.length:this.resultset.count()},p.prototype.data=function(){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data()},p.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var a=this;setTimeout(function(){a.rebuildPending&&(a.rebuildPending=!1,a.emit("rebuild",a))},this.options.minRebuildInterval)}},p.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var a=this;"active"===this.options.sortPriority?setTimeout(function(){a.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}},p.prototype.performSortPhase=function(a){(this.sortDirty||this.resultsdirty)&&(a=a||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),a.suppressRebuildEvent||this.emit("rebuild",this))},p.prototype.evaluateDocument=function(a,b){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var c=this.resultset.filteredrows,d=b?-1:c.indexOf(+a),e=c.length,f=new o(this.collection);f.filteredrows=[a],f.filterInitialized=!0;for(var g,h=0,i=this.filterPipeline.length;h<i;h++)g=this.filterPipeline[h],f[g.type](g.val);var j=0===f.filteredrows.length?-1:0;return-1!==d||-1!==j?-1===d&&-1!==j?(c.push(a),this.options.persistent&&this.resultdata.push(this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==d&&-1===j?(d<e-1?(c[d]=c[e-1],c.length=e-1,this.options.persistent&&(this.resultdata[d]=this.resultdata[e-1],this.resultdata.length=e-1)):(c.length=e-1,this.options.persistent&&(this.resultdata.length=e-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==d&&-1!==j?(this.options.persistent&&(this.resultdata[d]=this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},p.prototype.removeDocument=function(a){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent());var b,c=this.resultset.filteredrows,d=c.indexOf(+a),e=c.length;for(-1!==d&&(d<e-1?(c[d]=c[e-1],c.length=e-1,this.options.persistent&&(this.resultdata[d]=this.resultdata[e-1],this.resultdata.length=e-1)):(c.length=e-1,this.options.persistent&&(this.resultdata.length=e-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent()),e=c.length,b=0;b<e;b++)c[b]>a&&c[b]--},p.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},q.prototype=new k,q.prototype.console={log:function(){},warn:function(){},error:function(){}},q.prototype.addAutoUpdateObserver=function(a){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(a,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},q.prototype.removeAutoUpdateObserver=function(a){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(a,this.observerCallback)},q.prototype.addTransform=function(a,b){if(this.transforms.hasOwnProperty(a))throw new Error("a transform by that name already exists");this.transforms[a]=b},q.prototype.setTransform=function(a,b){this.transforms[a]=b},q.prototype.removeTransform=function(a){delete this.transforms[a]},q.prototype.byExample=function(a){var b,c,d;d=[];for(b in a)a.hasOwnProperty(b)&&d.push((c={},c[b]=a[b],c));return{$and:d}},q.prototype.findObject=function(a){return this.findOne(this.byExample(a))},q.prototype.findObjects=function(a){return this.find(this.byExample(a))},q.prototype.ttlDaemonFuncGen=function(){var a=this,b=this.ttl.age;return function(){var c=Date.now();a.chain().where(function(a){var d=a.meta.updated||a.meta.created;return b<c-d}).remove()}},q.prototype.setTTL=function(a,b){a<0?clearInterval(this.ttl.daemon):(this.ttl.age=a,this.ttl.ttlInterval=b,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),b))},q.prototype.prepareFullDocIndex=function(){for(var a=this.data.length,b=new Array(a),c=0;c<a;c+=1)b[c]=c;return b},q.prototype.ensureIndex=function(c,d){if(void 0===d&&(d=!1),null===c||void 0===c)throw new Error("Attempting to set index without an associated property");if(!this.binaryIndices[c]||d||this.binaryIndices[c].dirty){var e={name:c,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[c]=e;var f=function(c,d){return function(e,f){var g=d[e][c],h=d[f][c];if(g!==h){if(a(g,h,!1))return-1;if(b(g,h,!1))return 1}return 0}}(c,this.data);e.values.sort(f),e.dirty=!1,this.dirty=!0}},q.prototype.getSequencedIndexValues=function(a){var b,c=this.binaryIndices[a].values,d="";for(b=0;b<c.length;b++)d+=" ["+b+"] "+this.data[c[b]][a];return d},q.prototype.ensureUniqueIndex=function(a){var b=this.constraints.unique[a];return b||-1==this.uniqueNames.indexOf(a)&&this.uniqueNames.push(a),this.constraints.unique[a]=b=new B(a),this.data.forEach(function(a){b.set(a)}),b},q.prototype.ensureAllIndexes=function(a){var b,c=this.binaryIndices;for(b in c)E.call(c,b)&&this.ensureIndex(b,a)},q.prototype.flagBinaryIndexesDirty=function(){var a,b=this.binaryIndices;for(a in b)E.call(b,a)&&(b[a].dirty=!0)},q.prototype.flagBinaryIndexDirty=function(a){this.binaryIndices[a]&&(this.binaryIndices[a].dirty=!0)},q.prototype.count=function(a){return a?this.chain().find(a).filteredrows.length:this.data.length},q.prototype.ensureId=function(){var a=this.data.length,b=0;for(this.idIndex=[],b;b<a;b+=1)this.idIndex.push(this.data[b].$loki)},q.prototype.ensureIdAsync=function(a){this.async(function(){this.ensureId()},a)},q.prototype.addDynamicView=function(a,b){var c=new p(this,a,b);return this.DynamicViews.push(c),c},q.prototype.removeDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)this.DynamicViews[b].name===a&&this.DynamicViews.splice(b,1)},q.prototype.getDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)if(this.DynamicViews[b].name===a)return this.DynamicViews[b];return null},q.prototype.findAndUpdate=function(a,b){var c,d=this.where(a),e=0;try{for(e;e<d.length;e++)c=b(d[e]),this.update(c)}catch(f){this.rollback(),this.console.error(f.message)}},q.prototype.insert=function(a){if(!Array.isArray(a))return this.insertOne(a);for(var b,c=[],d=0,e=a.length;d<e;d++){if(!(b=this.insertOne(a[d])))return;c.push(b)}return 1===c.length?c[0]:c},q.prototype.insertOne=function(a){var b=null;if("object"!=typeof a?b=new TypeError("Document needs to be an object"):null===a&&(b=new TypeError("Object cannot be null")),null!==b)throw this.emit("error",b),b;var c=this.cloneObjects?h(a,this.cloneMethod):a;if(void 0===c.meta&&(c.meta={revision:0,created:0}),this.emit("pre-insert",c),this.add(c))return this.addAutoUpdateObserver(c),this.emit("insert",c),c},q.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},q.prototype.update=function(a){if(this.flagBinaryIndexesDirty(),Array.isArray(a)){var b=0,c=a.length;for(b;b<c;b+=1)this.update(a[b])}else{if(!E.call(a,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var d,e,f=this.get(a.$loki,!0),g=this;if(d=f[0],e=f[1],!f)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",a),Object.keys(this.constraints.unique).forEach(function(b){g.constraints.unique[b].update(d,a)}),this.data[e]=a,d!==a&&this.addAutoUpdateObserver(a);for(var h=0;h<this.DynamicViews.length;h++)this.DynamicViews[h].evaluateDocument(e,!1);return this.idIndex[e]=d.$loki,this.commit(),this.dirty=!0,this.emit("update",a),a}catch(i){throw this.rollback(),this.console.error(i.message),this.emit("error",i),i}}},q.prototype.add=function(a){if("object"!=typeof a)throw new TypeError("Object being added needs to be an object");if(void 0!==a.$loki)throw new Error("Document is already in collection, please use update()");this.flagBinaryIndexesDirty();try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),a.$loki=this.maxId,a.meta.version=0;var b,c=this.constraints.unique;for(b in c)E.call(c,b)&&c[b].set(a);this.idIndex.push(a.$loki),this.data.push(a);for(var d=this.data.length-1,e=this.DynamicViews.length,f=0;f<e;f++)this.DynamicViews[f].evaluateDocument(d,!0);return this.commit(),this.dirty=!0,this.cloneObjects?h(a,this.cloneMethod):a}catch(g){throw this.rollback(),this.console.error(g.message),this.emit("error",g),g}},q.prototype.removeWhere=function(a){var b;b="function"==typeof a?this.data.filter(a):new o(this,{queryObj:a}),this.remove(b)},q.prototype.removeDataOnly=function(){this.remove(this.data.slice())},q.prototype.remove=function(a){if("number"==typeof a&&(a=this.get(a)),"object"!=typeof a)throw new Error("Parameter is not an object");if(Array.isArray(a)){var b=0,c=a.length;for(b;b<c;b+=1)this.remove(a[b])}else{if(!E.call(a,"$loki"))throw new Error("Object is not a document stored in the collection");this.flagBinaryIndexesDirty();try{this.startTransaction();var d=this.get(a.$loki,!0),e=d[1],f=this;Object.keys(this.constraints.unique).forEach(function(b){null!==a[b]&&void 0!==a[b]&&f.constraints.unique[b].remove(a[b])});for(var g=0;g<this.DynamicViews.length;g++)this.DynamicViews[g].removeDocument(e);return this.data.splice(e,1),this.removeAutoUpdateObserver(a),this.idIndex.splice(e,1),this.commit(),this.dirty=!0,this.emit("delete",d[0]),delete a.$loki,delete a.meta,a}catch(h){return this.rollback(),this.console.error(h.message),this.emit("error",h),null}}},q.prototype.get=function(a,b){var c=b||!1,d=this.idIndex,e=d.length-1,f=0,g=f+e>>1;if(a="number"==typeof a?a:parseInt(a,10),isNaN(a))throw new TypeError("Passed id is not an integer");for(;d[f]<d[e];)g=f+e>>1,d[g]<a?f=g+1:e=g;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null},q.prototype.by=function(a,b){var c;if(void 0===b)return c=this,function(b){return c.by(a,b)};var d=this.constraints.unique[a].get(b);return this.cloneObjects?h(d,this.cloneMethod):d},q.prototype.findOne=function(a){var b=new o(this,{queryObj:a,firstOnly:!0});return Array.isArray(b)&&0===b.length?null:this.cloneObjects?h(b,this.cloneMethod):b},q.prototype.chain=function(a,b){var c=new o(this);return void 0===a?c:c.transform(a,b)},q.prototype.find=function(a){void 0===a&&(a="getAll");var b=new o(this,{queryObj:a});return this.cloneObjects?i(b,this.cloneMethod):b},q.prototype.findOneUnindexed=function(a,b){for(var c=this.data.length;c--;)if(this.data[c][a]===b)return this.data[c];return null},q.prototype.startTransaction=function(){if(this.transactional){this.cachedData=h(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].startTransaction()}},q.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].commit()}},q.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].rollback()}},q.prototype.async=function(a,b){setTimeout(function(){if("function"!=typeof a)throw new TypeError("Argument passed for async execution is not a function");a(),b()},0)},q.prototype.where=function(a){var b=new o(this,{queryFunc:a});return this.cloneObjects?i(b,this.cloneMethod):b},q.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c}},q.prototype.eqJoin=function(a,b,c,d){return new o(this).eqJoin(a,b,c,d)},q.prototype.stages={},q.prototype.getStage=function(a){return this.stages[a]||(this.stages[a]={}),this.stages[a]},q.prototype.commitLog=[],q.prototype.stage=function(a,b){var c=JSON.parse(JSON.stringify(b));return this.getStage(a)[b.$loki]=c,c},q.prototype.commitStage=function(a,b){var c,d=this.getStage(a),e=(new Date).getTime();for(c in d)this.update(d[c]),this.commitLog.push({timestamp:e,message:b,data:JSON.parse(JSON.stringify(d[c]))});this.stages[a]={}},q.prototype.no_op=function(){},q.prototype.extract=function(a){var b=0,c=this.data.length,d=r(a),e=[];for(b;b<c;b+=1)e.push(x(this.data[b],a,d));return e},q.prototype.max=function(a){return Math.max.apply(null,this.extract(a))},q.prototype.min=function(a){return Math.min.apply(null,this.extract(a))},q.prototype.maxRecord=function(a){var b,c=0,d=this.data.length,e=r(a),f={index:0,value:void 0};for(c;c<d;c+=1)void 0!==b?b<x(this.data[c],a,e)&&(b=x(this.data[c],a,e),f.index=this.data[c].$loki):(b=x(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},q.prototype.minRecord=function(a){var b,c=0,d=this.data.length,e=r(a),f={index:0,value:void 0};for(c;c<d;c+=1)void 0!==b?b>x(this.data[c],a,e)&&(b=x(this.data[c],a,e),f.index=this.data[c].$loki):(b=x(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},q.prototype.extractNumerical=function(a){return this.extract(a).map(s).filter(Number).filter(function(a){return!isNaN(a)})},q.prototype.avg=function(a){return v(this.extractNumerical(a))},q.prototype.stdDev=function(a){return w(this.extractNumerical(a))},q.prototype.mode=function(a){var b={};this.extract(a).forEach(function(a){b[a]?b[a]+=1:b[a]=1});var c,d,e;for(d in b)c?c<b[d]&&(e=d):(e=d,c=b[d]);return e},q.prototype.median=function(a){var b=this.extractNumerical(a);b.sort(u);var c=Math.floor(b.length/2);return b.length%2?b[c]:(b[c-1]+b[c])/2},A.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},setSort:function(a){this.bs=new z(a)},bs:function(){return new z(this.sort)},set:function(a,b){var c=this.bs(this.keys,a);c.found?this.values[c.index]=b:(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,b))},get:function(a){return this.values[y(this.keys,a,this.sort).index]}},B.prototype.keyMap={},B.prototype.lokiMap={},B.prototype.set=function(a){var b=a[this.field];if(null!==b&&void 0!==b){if(this.keyMap[b])throw new Error("Duplicate key for property "+this.field+": "+b);this.keyMap[b]=a,this.lokiMap[a.$loki]=b}},B.prototype.get=function(a){return this.keyMap[a]},B.prototype.byId=function(a){return this.keyMap[this.lokiMap[a]]},B.prototype.update=function(a,b){if(this.lokiMap[a.$loki]!==b[this.field]){var c=this.lokiMap[a.$loki];this.set(b),this.keyMap[c]=void 0}else this.keyMap[a[this.field]]=b},B.prototype.remove=function(a){var b=this.keyMap[a];if(null===b||void 0===b)throw new Error("Key is not in unique index: "+this.field);this.keyMap[a]=void 0,this.lokiMap[b.$loki]=void 0},B.prototype.clear=function(){this.keyMap={},this.lokiMap={}},C.prototype={set:function(a,b){this.index[a]?this.index[a].push(b):this.index[a]=[b]},remove:function(a,b){var c=this.index[a];for(var d in c)c[d]==b&&c.splice(d,1);c.length<1&&(this.index[a]=void 0)},get:function(a){return this.index[a]},clear:function(a){this.index={}}},D.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},bs:function(){return new z(this.sort)},setSort:function(a){this.bs=new z(a)},set:function(a,b){var c=y(this.keys,a,this.sort);c.found?this.values[c.index].push(b):(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,[b]))},get:function(a){var b=y(this.keys,a,this.sort);return b.found?this.values[b.index]:[]},getLt:function(a){var b=y(this.keys,a,this.sort),c=b.index;return b.found&&c--,this.getAll(a,0,c)},getGt:function(a){var b=y(this.keys,a,this.sort),c=b.index;return b.found&&c++,this.getAll(a,c,this.keys.length)},getAll:function(a,b,c){for(var d=[],e=b;e<c;e++)d=d.concat(this.values[e]);return d},getPos:function(a){return y(this.keys,a,this.sort)},remove:function(a,b){var c=y(this.keys,a,this.sort).index,d=this.values[c];for(var e in d)d[e]==b&&d.splice(e,1);d.length<1&&(this.keys.splice(c,1),this.values.splice(c,1))},clear:function(){this.keys=[],this.values=[]}},l.LokiOps=G,l.Collection=q,l.KeyValueStore=A,l.persistenceAdapters={fs:m,localStorage:n},l}()}),function(){"use strict";function a(a){return"function"==typeof a||"object"==typeof a&&null!==a}function b(a){return"function"==typeof a}function c(a){S=a}function d(a){W=a}function e(){return function(){process.nextTick(j)}}function f(){return function(){R(j)}}function g(){var a=0,b=new Z(j),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function h(){var a=new MessageChannel;return a.port1.onmessage=j,function(){a.port2.postMessage(0)}}function i(){return function(){setTimeout(j,1)}}function j(){for(var a=0;a<V;a+=2){(0,aa[a])(aa[a+1]),aa[a]=void 0,aa[a+1]=void 0}V=0}function k(){try{var a=require,b=a("vertx");return R=b.runOnLoop||b.runOnContext,f()}catch(c){return i()}}function l(a,b){var c=this,d=new this.constructor(n);void 0===d[da]&&G(d);var e=c._state;if(e){var f=arguments[e-1];W(function(){D(e,d,f,c._result)})}else z(c,d,a,b);return d}function m(a){var b=this;if(a&&"object"==typeof a&&a.constructor===b)return a;var c=new b(n);return v(c,a),c}function n(){}function o(){return new TypeError("You cannot resolve a promise with itself")}function p(){return new TypeError("A promises callback cannot return that same promise.")}function q(a){try{return a.then}catch(b){return ha.error=b,ha}}function r(a,b,c,d){try{a.call(b,c,d)}catch(e){return e}}function s(a,b,c){W(function(a){var d=!1,e=r(c,b,function(c){d||(d=!0,b!==c?v(a,c):x(a,c))},function(b){d||(d=!0,y(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,y(a,e))},a)}function t(a,b){b._state===fa?x(a,b._result):b._state===ga?y(a,b._result):z(b,void 0,function(b){v(a,b)},function(b){y(a,b)})}function u(a,c,d){c.constructor===a.constructor&&d===ba&&constructor.resolve===ca?t(a,c):d===ha?y(a,ha.error):void 0===d?x(a,c):b(d)?s(a,c,d):x(a,c)}function v(b,c){b===c?y(b,o()):a(c)?u(b,c,q(c)):x(b,c)}function w(a){a._onerror&&a._onerror(a._result),A(a)}function x(a,b){a._state===ea&&(a._result=b,a._state=fa,0!==a._subscribers.length&&W(A,a))}function y(a,b){a._state===ea&&(a._state=ga,a._result=b,W(w,a))}function z(a,b,c,d){var e=a._subscribers,f=e.length;a._onerror=null,e[f]=b,e[f+fa]=c,e[f+ga]=d,0===f&&a._state&&W(A,a)}function A(a){var b=a._subscribers,c=a._state;if(0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?D(c,d,e,f):e(f);a._subscribers.length=0}}function B(){this.error=null}function C(a,b){try{return a(b)}catch(c){return ia.error=c,ia}}function D(a,c,d,e){var f,g,h,i,j=b(d);if(j){if(f=C(d,e),f===ia?(i=!0,g=f.error,f=null):h=!0,c===f)return void y(c,p())}else f=e,h=!0;c._state!==ea||(j&&h?v(c,f):i?y(c,g):a===fa?x(c,f):a===ga&&y(c,f))}function E(a,b){try{b(function(b){v(a,b)},function(b){y(a,b)})}catch(c){y(a,c)}}function F(){return ja++}function G(a){a[da]=ja++,a._state=void 0,a._result=void 0,a._subscribers=[]}function H(a){return new oa(this,a).promise}function I(a){var b=this;return new b(U(a)?function(c,d){for(var e=a.length,f=0;f<e;f++)b.resolve(a[f]).then(c,d)}:function(a,b){b(new TypeError("You must pass an array to race."))})}function J(a){var b=this,c=new b(n);return y(c,a),c}function K(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function L(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function M(a){this[da]=F(),this._result=this._state=void 0,this._subscribers=[],n!==a&&("function"!=typeof a&&K(),this instanceof M?E(this,a):L())}function N(a,b){this._instanceConstructor=a,this.promise=new a(n),this.promise[da]||G(this.promise),Array.isArray(b)?(this._input=b,this.length=b.length,this._remaining=b.length,this._result=new Array(this.length),0===this.length?x(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&x(this.promise,this._result))):y(this.promise,O())}function O(){return new Error("Array Methods must be provided an Array")}function P(){var a;if("undefined"!=typeof global)a=global;else if("undefined"!=typeof self)a=self;else try{a=Function("return this")()}catch(c){throw new Error("polyfill failed because global object is unavailable in this environment")}var b=a.Promise
;b&&"[object Promise]"===Object.prototype.toString.call(b.resolve())&&!b.cast||(a.Promise=na)}var Q;Q=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};var R,S,T,U=Q,V=0,W=function(a,b){aa[V]=a,aa[V+1]=b,2===(V+=2)&&(S?S(j):T())},X="undefined"!=typeof window?window:void 0,Y=X||{},Z=Y.MutationObserver||Y.WebKitMutationObserver,$="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),_="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,aa=new Array(1e3);T=$?e():Z?g():_?h():void 0===X&&"function"==typeof require?k():i();var ba=l,ca=m,da=Math.random().toString(36).substring(16),ea=void 0,fa=1,ga=2,ha=new B,ia=new B,ja=0,ka=H,la=I,ma=J,na=M;M.all=ka,M.race=la,M.resolve=ca,M.reject=ma,M._setScheduler=c,M._setAsap=d,M._asap=W,M.prototype={constructor:M,then:ba,catch:function(a){return this.then(null,a)}};var oa=N;N.prototype._enumerate=function(){for(var a=this.length,b=this._input,c=0;this._state===ea&&c<a;c++)this._eachEntry(b[c],c)},N.prototype._eachEntry=function(a,b){var c=this._instanceConstructor,d=c.resolve;if(d===ca){var e=q(a);if(e===ba&&a._state!==ea)this._settledAt(a._state,b,a._result);else if("function"!=typeof e)this._remaining--,this._result[b]=a;else if(c===na){var f=new c(n);u(f,a,e),this._willSettleAt(f,b)}else this._willSettleAt(new c(function(b){b(a)}),b)}else this._willSettleAt(d(a),b)},N.prototype._settledAt=function(a,b,c){var d=this.promise;d._state===ea&&(this._remaining--,a===ga?y(d,c):this._result[b]=c),0===this._remaining&&x(d,this._result)},N.prototype._willSettleAt=function(a,b){var c=this;z(a,void 0,function(a){c._settledAt(fa,b,a)},function(a){c._settledAt(ga,b,a)})};var pa=P,qa={Promise:na,polyfill:pa};"function"==typeof define&&define.amd?define(function(){return qa}):"undefined"!=typeof module&&module.exports?module.exports=qa:void 0!==this&&(this.ES6Promise=qa),pa()}.call(this),b.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var E=Object.prototype.toString,F=Array.isArray||function(a){return"[object Array]"===E.call(a)},G=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");!function(a){"use strict";function b(){var b=a.crypto||a.msCrypto;if(!h&&b&&b.getRandomValues)try{var c=new Uint8Array(16);k=h=function(){return b.getRandomValues(c),c},h()}catch(e){}if(!h){var d=new Array(16);i=h=function(){for(var a,b=0;b<16;b++)0==(3&b)&&(a=4294967296*Math.random()),d[b]=a>>>((3&b)<<3)&255;return d},"undefined"!=typeof console&&console.warn&&console.warn("[SECURITY] node-uuid: crypto not usable, falling back to insecure Math.random()")}}function c(){if("function"==typeof require)try{var a=require("crypto").randomBytes;j=h=a&&function(){return a(16)},h()}catch(b){}}function d(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){e<16&&(b[d+e++]=o[a])});e<16;)b[d+e++]=0;return b}function e(a,b){var c=b||0,d=n;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function f(a,b,c){var d=b&&c||0,f=b||[];a=a||{};var g=null!=a.clockseq?a.clockseq:s,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:u+1,j=h-t+(i-u)/1e4;if(j<0&&null==a.clockseq&&(g=g+1&16383),(j<0||h>t)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");t=h,u=i,s=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[d++]=k>>>24&255,f[d++]=k>>>16&255,f[d++]=k>>>8&255,f[d++]=255&k;var l=h/4294967296*1e4&268435455;f[d++]=l>>>8&255,f[d++]=255&l,f[d++]=l>>>24&15|16,f[d++]=l>>>16&255,f[d++]=g>>>8|128,f[d++]=255&g;for(var m=a.node||r,n=0;n<6;n++)f[d+n]=m[n];return b||e(f)}function g(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new m(16):null,a=null),a=a||{};var f=a.random||(a.rng||h)();if(f[6]=15&f[6]|64,f[8]=63&f[8]|128,b)for(var g=0;g<16;g++)b[d+g]=f[g];return b||e(f)}var h,i,j,k,l;a?b():c();for(var m="function"==typeof Buffer?Buffer:Array,n=[],o={},p=0;p<256;p++)n[p]=(p+256).toString(16).substr(1),o[n[p]]=p;var q=h(),r=[1|q[0],q[1],q[2],q[3],q[4],q[5]],s=16383&(q[6]<<8|q[7]),t=0,u=0,v=g;v.v1=f,v.v4=g,v.parse=d,v.unparse=e,v.BufferClass=m,v._rng=h,v._mathRNG=i,v._nodeRNG=j,v._whatwgRNG=k,"undefined"!=typeof module&&module.exports?module.exports=v:"function"==typeof define&&define.amd?define(function(){return v}):(l=a.uuid,v.noConflict=function(){return a.uuid=l,v},a.uuid=v)}("undefined"!=typeof window?window:null),Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Array.prototype.findIndex||(Array.prototype.findIndex=function(a){if(null===this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;f<d;f++)if(b=c[f],a.call(e,b,f,c))return f;return-1}),Array.prototype.filter||(Array.prototype.filter=function(a){"use strict";if(void 0===this||null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d}),v.prototype.events={},v.prototype.asyncListeners=!1,v.prototype.on=function(a,b){var c=this.events[a];return c||(c=this.events[a]=[]),c.push(b),b},v.prototype.emit=function(a,b){var c=this;if(!a||!this.events[a])throw new Error("No event "+a+" defined");this.events[a].forEach(function(a){c.asyncListeners?setTimeout(function(){a(b)},1):a(b)})},v.prototype.removeListener=function(a,b){if(this.events[a]){var c=this.events[a];c.splice(c.indexOf(b),1)}},a.mcs={},a.mcs._sync=A(),B?(define=B,B=void 0):C&&(exports=C,C=void 0)}(this);